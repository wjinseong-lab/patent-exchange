<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Global Patent Exchange - AI-Powered Patent Trading & Licensing</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.js"></script>
<style>
:root{--navy:#1e3a5f;--navy-light:#2563eb;--emerald:#10b981;--emerald-d:#059669;--amber:#f59e0b;--amber-d:#d97706;--cyan:#06b6d4;--red:#ef4444;--purple:#8b5cf6;--gray-50:#f9fafb;--gray-100:#f3f4f6;--gray-200:#e5e7eb;--gray-300:#d1d5db;--gray-400:#9ca3af;--gray-500:#6b7280;--gray-600:#4b5563;--gray-700:#374151;--gray-800:#1f2937;--gray-900:#111827;--sep-bg:#fef3c7;--sep-color:#92400e;--sep-border:#f59e0b;}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Noto Sans KR',sans-serif;background:var(--gray-50);color:var(--gray-800);min-height:100vh;}
.container{max-width:1360px;margin:0 auto;padding:0 20px;}
header{background:#fff;border-bottom:1px solid var(--gray-100);position:sticky;top:0;z-index:40;}
.header-inner{display:flex;align-items:center;justify-content:space-between;padding:12px 0;gap:10px;}
.logo-area{display:flex;align-items:center;gap:10px;}
.logo-icon{width:42px;height:42px;background:linear-gradient(135deg,var(--navy),var(--navy-light));border-radius:12px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900;font-size:13px;letter-spacing:-.5px;box-shadow:0 4px 12px rgba(37,99,235,.3);}
.logo-text h1{font-size:18px;font-weight:800;}.logo-text p{font-size:10px;color:var(--gray-400);}
.header-right{display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
.header-kr{font-size:11px;color:var(--gray-400);border-right:1px solid var(--gray-200);padding-right:12px;line-height:1.4;text-align:right;}
.header-kr .kr-title{font-weight:700;color:var(--gray-600);}
.role-selector{display:flex;align-items:center;gap:6px;}
.role-btn{padding:6px 12px;font-size:11px;font-weight:600;border-radius:8px;border:1.5px solid var(--gray-200);background:#fff;color:var(--gray-500);cursor:pointer;transition:all .2s;white-space:nowrap;}
.role-btn:hover{border-color:var(--navy-light);color:var(--navy);}
.role-btn.active{background:var(--navy);color:#fff;border-color:var(--navy);box-shadow:0 2px 8px rgba(30,58,95,.3);}
.role-btn .role-icon{margin-right:3px;}
nav{background:#fff;border-bottom:1px solid var(--gray-100);}
.nav-inner{display:flex;gap:4px;padding:6px 0;overflow-x:auto;}
.tab-btn{display:flex;align-items:center;gap:5px;padding:8px 14px;font-size:11px;font-weight:600;border-radius:10px;border:none;cursor:pointer;background:transparent;color:var(--gray-500);transition:all .2s;white-space:nowrap;}
.tab-btn:hover{background:var(--gray-100);color:var(--gray-700);}
.tab-btn.active{background:var(--navy);color:#fff;box-shadow:0 4px 12px rgba(30,58,95,.3);}
.tab-btn svg{width:14px;height:14px;}
.tab-btn .kr{font-size:9px;opacity:.7;margin-left:2px;}
main{padding:20px 0;}
.tab-content{display:none;}.tab-content.active{display:block;}
.stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px;margin-bottom:20px;}
.stat-card{padding:18px;border-radius:14px;color:#fff;box-shadow:0 4px 16px rgba(0,0,0,.1);}
.stat-card .label{font-size:11px;opacity:.9;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center;}
.stat-card .label .emoji{font-size:20px;}
.stat-card .val{font-size:24px;font-weight:800;}
.stat-card .val .unit{font-size:12px;font-weight:400;margin-left:3px;}
.stat-card .kr-sub{font-size:9px;opacity:.7;margin-top:3px;}
.bg-navy{background:linear-gradient(135deg,var(--navy),var(--navy-light));}
.bg-emerald{background:linear-gradient(135deg,var(--emerald),var(--emerald-d));}
.bg-amber{background:linear-gradient(135deg,var(--amber),var(--amber-d));}
.bg-cyan{background:linear-gradient(135deg,var(--cyan),#0891b2);}
.bg-purple{background:linear-gradient(135deg,var(--purple),#7c3aed);}
.bg-red{background:linear-gradient(135deg,#f87171,var(--red));}
.card{background:#fff;border-radius:14px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,.05);border:1px solid var(--gray-100);margin-bottom:16px;}
.card h3{font-size:15px;font-weight:700;margin-bottom:14px;}
.card h3 .kr{font-size:10px;color:var(--gray-400);font-weight:500;margin-left:6px;}
.chart-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;}
.chart-container{position:relative;height:280px;}
table{width:100%;border-collapse:collapse;font-size:12px;}
th{text-align:left;padding:10px;font-weight:600;color:var(--gray-500);border-bottom:2px solid var(--gray-100);font-size:10px;text-transform:uppercase;letter-spacing:.3px;}
td{padding:9px 10px;border-bottom:1px solid var(--gray-50);}
tr:hover td{background:var(--gray-50);}
.mono{font-family:'SF Mono','Fira Code',monospace;font-size:10px;color:var(--gray-400);}
.badge{display:inline-block;padding:2px 8px;border-radius:50px;font-size:10px;font-weight:600;}
.badge-green{background:#dcfce7;color:#15803d;}.badge-blue{background:#dbeafe;color:#1d4ed8;}
.badge-amber{background:#fef3c7;color:var(--amber-d);}.badge-purple{background:#f3e8ff;color:#7c3aed;}
.badge-gray{background:var(--gray-100);color:var(--gray-600);}.badge-red{background:#fee2e2;color:#dc2626;}
.badge-sep{background:linear-gradient(135deg,#fbbf24,var(--amber));color:#78350f;font-weight:700;letter-spacing:.5px;padding:2px 8px;border-radius:50px;font-size:9px;text-transform:uppercase;box-shadow:0 1px 4px rgba(245,158,11,.35);}
.badge-sep::before{content:'‚òÖ ';font-size:8px;}
.sep-indicator{display:inline-flex;align-items:center;gap:4px;background:linear-gradient(135deg,#fffbeb,#fef3c7);border:1.5px solid var(--sep-border);border-radius:8px;padding:3px 8px;font-size:9px;font-weight:700;color:var(--sep-color);}
.filter-bar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;}
.filter-bar input,.filter-bar select{padding:8px 14px;border-radius:10px;border:1px solid var(--gray-200);font-size:12px;outline:none;transition:box-shadow .2s;}
.filter-bar input:focus,.filter-bar select:focus{box-shadow:0 0 0 3px rgba(37,99,235,.15);border-color:var(--navy-light);}
.filter-bar input{flex:1;min-width:180px;}
.patent-item{background:#fff;border-radius:14px;padding:16px;border:1px solid var(--gray-100);margin-bottom:10px;transition:box-shadow .2s;}
.patent-item:hover{box-shadow:0 4px 16px rgba(0,0,0,.08);}
.patent-item.is-sep{border-left:4px solid var(--sep-border);}
.patent-header{display:flex;justify-content:space-between;align-items:flex-start;gap:14px;flex-wrap:wrap;}
.patent-info{flex:1;min-width:220px;}
.patent-meta{display:flex;gap:5px;align-items:center;margin-bottom:4px;flex-wrap:wrap;}
.patent-title{font-size:14px;font-weight:700;cursor:pointer;transition:color .2s;}
.patent-title:hover{color:var(--navy-light);}
.patent-title-kr{font-size:11px;color:var(--gray-400);margin-bottom:4px;}
.patent-sub{font-size:11px;color:var(--gray-500);margin-bottom:4px;}
.patent-sub strong{color:var(--gray-700);}
.patent-desc{font-size:11px;color:var(--gray-400);display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.patent-actions{text-align:right;display:flex;flex-direction:column;align-items:flex-end;gap:8px;}
.patent-value{font-size:20px;font-weight:800;color:var(--navy);}
.btn-group{display:flex;gap:5px;flex-wrap:wrap;}
.btn{padding:6px 12px;font-size:10px;font-weight:600;border-radius:8px;border:none;cursor:pointer;transition:all .2s;}
.btn-outline{border:1px solid var(--gray-200);color:var(--gray-600);background:#fff;}.btn-outline:hover{background:var(--gray-50);}
.btn-primary{background:var(--navy);color:#fff;box-shadow:0 2px 8px rgba(30,58,95,.25);}.btn-primary:hover{background:#162d4d;}
.btn-emerald{background:var(--emerald-d);color:#fff;}.btn-emerald:hover{background:#047857;}
.btn-orange{background:#f97316;color:#fff;}.btn-orange:hover{background:#ea580c;}
.btn-gray{background:var(--gray-100);color:var(--gray-600);}.btn-gray:hover{background:var(--gray-200);}
.btn-purple{background:var(--purple);color:#fff;}.btn-purple:hover{background:#7c3aed;}
.btn-lg{padding:12px 20px;font-size:13px;border-radius:12px;flex:1;}
.btn-link{background:none;border:none;color:var(--navy-light);cursor:pointer;font-size:10px;font-weight:600;}.btn-link:hover{text-decoration:underline;}
.modal-overlay{display:none;position:fixed;inset:0;z-index:50;background:rgba(0,0,0,.5);align-items:center;justify-content:center;padding:16px;}
.modal-overlay.show{display:flex;}
.modal{background:#fff;border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.2);width:100%;max-height:90vh;overflow-y:auto;}
.modal-sm{max-width:540px;}.modal-md{max-width:620px;}.modal-lg{max-width:760px;}.modal-xl{max-width:960px;}
.modal-header{display:flex;justify-content:space-between;align-items:center;padding:20px 20px 0;}
.modal-header h2{font-size:16px;font-weight:700;}
.modal-header h2 .kr{font-size:11px;color:var(--gray-400);font-weight:500;margin-left:6px;}
.modal-close{width:32px;height:32px;border-radius:50%;border:none;cursor:pointer;background:var(--gray-100);font-size:16px;display:flex;align-items:center;justify-content:center;}
.modal-close:hover{background:var(--gray-200);}
.modal-body{padding:20px;}
.form-group{margin-bottom:12px;}
.form-label{display:block;font-size:11px;font-weight:600;color:var(--gray-700);margin-bottom:5px;}
.form-label .kr{font-size:9px;color:var(--gray-400);font-weight:400;margin-left:4px;}
.form-input,.form-select,.form-textarea{width:100%;padding:9px 14px;border-radius:10px;border:1px solid var(--gray-200);font-size:12px;outline:none;transition:box-shadow .2s;font-family:inherit;}
.form-input:focus,.form-select:focus,.form-textarea:focus{box-shadow:0 0 0 3px rgba(37,99,235,.15);border-color:var(--navy-light);}
.form-hint{font-size:10px;color:var(--gray-400);margin-top:3px;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.form-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;}
.info-box{border-radius:12px;padding:14px;margin-bottom:16px;}
.info-box-blue{background:#eff6ff;}.info-box-emerald{background:#ecfdf5;}
.info-box .info-label{font-size:10px;margin-bottom:3px;}
.info-box .info-title{font-size:14px;font-weight:700;}
.info-box .info-sub{font-size:11px;color:var(--gray-500);margin-top:3px;}
.type-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;}
.type-card{padding:14px;border-radius:12px;border:2px solid var(--gray-200);cursor:pointer;text-align:left;background:#fff;transition:all .2s;}
.type-card:hover{border-color:var(--gray-300);}.type-card.selected{border-color:var(--emerald);background:#ecfdf5;}
.type-card h4{font-size:13px;font-weight:700;margin-bottom:3px;}.type-card p{font-size:10px;color:var(--gray-500);}
.condition-box{background:var(--gray-50);border-radius:12px;padding:14px;margin-bottom:14px;}
.condition-box h4{font-size:12px;font-weight:700;margin-bottom:10px;color:var(--gray-700);}
.sim-box{background:#fff;border-radius:10px;padding:10px 14px;border:1px solid var(--gray-200);margin-top:10px;}
.sim-label{font-size:10px;font-weight:600;color:var(--gray-500);margin-bottom:3px;}
.sim-value{font-size:18px;font-weight:800;color:var(--emerald-d);}
.sim-sub{font-size:10px;color:var(--gray-400);margin-top:2px;}
.score-bar-bg{width:50px;height:7px;background:var(--gray-100);border-radius:50px;display:inline-block;vertical-align:middle;margin-right:4px;}
.score-bar{height:7px;border-radius:50px;}
.detail-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;margin-bottom:16px;}
.detail-item{background:var(--gray-50);border-radius:10px;padding:10px;}
.detail-item .d-label{font-size:9px;color:var(--gray-400);margin-bottom:3px;text-transform:uppercase;letter-spacing:.3px;}
.detail-item .d-value{font-size:13px;font-weight:700;color:var(--gray-700);}
.notification{position:fixed;top:14px;right:14px;z-index:100;padding:12px 20px;border-radius:12px;color:#fff;font-size:12px;font-weight:600;box-shadow:0 8px 24px rgba(0,0,0,.15);transform:translateY(-20px);opacity:0;transition:all .3s;max-width:400px;}
.notification.show{transform:translateY(0);opacity:1;}
.notification.success{background:var(--emerald);}.notification.error{background:var(--red);}.notification.info{background:var(--navy-light);}
footer{border-top:1px solid var(--gray-100);background:#fff;margin-top:30px;padding:14px 0;text-align:center;font-size:10px;color:var(--gray-400);}
/* AI AGENT STYLES */
.agent-card{background:#fff;border-radius:14px;padding:16px;border:1px solid var(--gray-100);margin-bottom:10px;transition:all .2s;position:relative;}
.agent-card:hover{box-shadow:0 4px 16px rgba(0,0,0,.08);}
.agent-card.agent-active{border-left:4px solid var(--emerald);}
.agent-card.agent-paused{border-left:4px solid var(--gray-300);opacity:.7;}
.agent-avatar{width:48px;height:48px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0;}
.agent-header{display:flex;gap:12px;align-items:flex-start;}
.agent-info{flex:1;}
.agent-name{font-size:14px;font-weight:700;}
.agent-type{font-size:10px;color:var(--gray-400);margin-top:2px;}
.agent-stats{display:flex;gap:12px;margin-top:10px;flex-wrap:wrap;}
.agent-stat{background:var(--gray-50);border-radius:8px;padding:8px 12px;font-size:10px;text-align:center;min-width:80px;}
.agent-stat .as-val{font-size:16px;font-weight:800;color:var(--navy);}
.agent-stat .as-label{color:var(--gray-400);margin-top:2px;}
.agent-actions-bar{display:flex;gap:6px;margin-top:10px;}
/* Activity Feed */
.feed-item{display:flex;gap:10px;padding:10px 0;border-bottom:1px solid var(--gray-50);font-size:12px;align-items:flex-start;}
.feed-icon{width:32px;height:32px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;}
.feed-content{flex:1;}.feed-title{font-weight:600;margin-bottom:2px;}.feed-desc{color:var(--gray-500);font-size:11px;}
.feed-time{font-size:10px;color:var(--gray-400);white-space:nowrap;}
/* Recommendation */
.rec-card{background:linear-gradient(135deg,#eff6ff,#dbeafe);border:1px solid #93c5fd;border-radius:14px;padding:16px;margin-bottom:10px;}
.rec-card h4{font-size:13px;font-weight:700;color:var(--navy);margin-bottom:6px;display:flex;align-items:center;gap:6px;}
.rec-card p{font-size:11px;color:var(--gray-600);line-height:1.5;}
.rec-card .rec-action{display:flex;gap:6px;margin-top:10px;}
.rec-score{display:inline-flex;align-items:center;gap:3px;background:var(--navy);color:#fff;padding:2px 8px;border-radius:20px;font-size:10px;font-weight:700;}
/* Negotiation */
.nego-timeline{position:relative;padding-left:24px;}
.nego-timeline::before{content:'';position:absolute;left:8px;top:0;bottom:0;width:2px;background:var(--gray-200);}
.nego-step{position:relative;padding:8px 0 16px;font-size:12px;}
.nego-step::before{content:'';position:absolute;left:-20px;top:12px;width:12px;height:12px;border-radius:50%;border:2px solid var(--gray-300);background:#fff;z-index:1;}
.nego-step.done::before{background:var(--emerald);border-color:var(--emerald);}
.nego-step.active::before{background:var(--navy-light);border-color:var(--navy-light);box-shadow:0 0 0 4px rgba(37,99,235,.2);}
.nego-step .ns-title{font-weight:600;}.nego-step .ns-desc{color:var(--gray-500);font-size:11px;margin-top:2px;}
/* Candle */
.candle-wrap{background:var(--gray-900);border-radius:14px;overflow:hidden;}
.candle-toolbar{display:flex;gap:4px;padding:10px 14px;background:var(--gray-900);align-items:center;flex-wrap:wrap;}
.candle-toolbar .tb-label{font-size:10px;color:var(--gray-400);margin-right:6px;}
.candle-toolbar .tb-btn{padding:4px 10px;font-size:10px;font-weight:600;border:1px solid #374151;border-radius:6px;background:transparent;color:var(--gray-400);cursor:pointer;transition:all .15s;}
.candle-toolbar .tb-btn:hover{background:#374151;color:#fff;}.candle-toolbar .tb-btn.active{background:var(--navy-light);color:#fff;border-color:var(--navy-light);}
.candle-toolbar .tb-sep{width:1px;height:18px;background:#374151;margin:0 6px;}
.candle-info{display:flex;gap:14px;padding:0 14px 6px;font-size:10px;}
.candle-info span{color:var(--gray-400);}.candle-info .up{color:#22c55e;}.candle-info .down{color:var(--red);}
.candle-canvas-wrap canvas{display:block;width:100%;cursor:crosshair;}
.candle-legend{display:flex;gap:14px;padding:6px 14px 10px;font-size:9px;color:var(--gray-400);}
.candle-legend .leg-dot{display:inline-block;width:8px;height:3px;border-radius:2px;margin-right:3px;vertical-align:middle;}
.chart-patent-select{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px;}
.chart-patent-chip{padding:5px 12px;font-size:10px;font-weight:600;border-radius:8px;border:1px solid var(--gray-200);background:#fff;color:var(--gray-600);cursor:pointer;transition:all .15s;white-space:nowrap;}
.chart-patent-chip:hover{border-color:var(--navy-light);color:var(--navy-light);}
.chart-patent-chip.active{background:var(--navy);color:#fff;border-color:var(--navy);}
.sep-filter{padding:5px 12px;font-size:10px;font-weight:700;border-radius:8px;border:2px solid var(--sep-border);background:var(--sep-bg);color:var(--sep-color);cursor:pointer;}.sep-filter.active{background:var(--amber);color:#fff;}
.upload-zone{border:2px dashed var(--gray-300);border-radius:14px;padding:28px;text-align:center;cursor:pointer;transition:all .2s;margin-bottom:14px;background:var(--gray-50);}
.upload-zone:hover,.upload-zone.dragover{border-color:var(--navy-light);background:#eff6ff;}
.pulse{animation:pulse 2s infinite;}@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.5;}}
@media(max-width:768px){.chart-row{grid-template-columns:1fr;}.form-row,.form-row-3,.type-grid{grid-template-columns:1fr;}.patent-header{flex-direction:column;}.header-kr,.header-value{display:none;}.role-selector{display:none;}}
</style>
</head>
<body>
<div id="notification" class="notification"></div>

<header>
<div class="container">
<div class="header-inner">
  <div class="logo-area">
    <div class="logo-icon">GPX</div>
    <div class="logo-text"><h1>Global Patent Exchange</h1><p>AI-Powered Patent Trading & Licensing</p></div>
  </div>
  <div class="header-right">
    <div class="header-kr"><div class="kr-title">Í∏ÄÎ°úÎ≤å ÌäπÌóà Í±∞ÎûòÏÜå</div><div>AI Í∏∞Î∞ò ÌäπÌóà Í±∞Îûò & ÎùºÏù¥ÏÑºÏã±</div></div>
    <div class="role-selector" id="roleSelector"></div>
    <div style="font-size:12px;color:var(--gray-500)">Portfolio: <strong id="totalValue" style="color:var(--navy);font-size:14px"></strong></div>
    <button class="btn btn-orange" onclick="openUploadModal()" style="font-size:11px;padding:7px 14px;border-radius:10px">+ Register Patent</button>
  </div>
</div>
</div>
</header>

<nav>
<div class="container"><div class="nav-inner" id="navTabs"></div></div>
</nav>

<main class="container">
<div id="tab-dashboard" class="tab-content active"></div>
<div id="tab-patents" class="tab-content"></div>
<div id="tab-agents" class="tab-content"></div>
<div id="tab-chart" class="tab-content"></div>
<div id="tab-value" class="tab-content"></div>
<div id="tab-transactions" class="tab-content"></div>
</main>

<footer><div class="container">Global Patent Exchange &copy; 2026 &middot; AI-Powered Patent Trading & Licensing &middot; Í∏ÄÎ°úÎ≤å ÌäπÌóà Í±∞ÎûòÏÜå</div></footer>

<!-- Modals -->
<div id="detailModal" class="modal-overlay" onclick="if(event.target===this)closeModal('detailModal')"><div class="modal modal-lg"><div class="modal-header"><h2>Patent Details <span class="kr">ÌäπÌóà ÏÉÅÏÑ∏</span></h2><button class="modal-close" onclick="closeModal('detailModal')">&times;</button></div><div class="modal-body" id="detailBody"></div></div></div>
<div id="tradeModal" class="modal-overlay" onclick="if(event.target===this)closeModal('tradeModal')"><div class="modal modal-md"><div class="modal-header"><h2>Trade Request <span class="kr">Í±∞Îûò ÏöîÏ≤≠</span></h2><button class="modal-close" onclick="closeModal('tradeModal')">&times;</button></div><div class="modal-body" id="tradeBody"></div></div></div>
<div id="licenseModal" class="modal-overlay" onclick="if(event.target===this)closeModal('licenseModal')"><div class="modal modal-lg"><div class="modal-header"><h2>License Request <span class="kr">ÎùºÏù¥ÏÑºÏä§ ÏöîÏ≤≠</span></h2><button class="modal-close" onclick="closeModal('licenseModal')">&times;</button></div><div class="modal-body" id="licenseBody"></div></div></div>
<div id="uploadModal" class="modal-overlay" onclick="if(event.target===this)closeModal('uploadModal')"><div class="modal modal-lg"><div class="modal-header"><h2>Register Patent <span class="kr">ÌäπÌóà Îì±Î°ù</span></h2><button class="modal-close" onclick="closeModal('uploadModal')">&times;</button></div><div class="modal-body" id="uploadBody"></div></div></div>
<div id="candleModal" class="modal-overlay" onclick="if(event.target===this)closeModal('candleModal')"><div class="modal modal-xl"><div class="modal-header"><h2 id="candleModalTitle">Value Chart</h2><button class="modal-close" onclick="closeModal('candleModal')">&times;</button></div><div class="modal-body" id="candleModalBody" style="padding:0"></div></div></div>
<div id="agentModal" class="modal-overlay" onclick="if(event.target===this)closeModal('agentModal')"><div class="modal modal-lg"><div class="modal-header"><h2 id="agentModalTitle">AI Agent</h2><button class="modal-close" onclick="closeModal('agentModal')">&times;</button></div><div class="modal-body" id="agentModalBody"></div></div></div>
<div id="negoModal" class="modal-overlay" onclick="if(event.target===this)closeModal('negoModal')"><div class="modal modal-lg"><div class="modal-header"><h2>AI Negotiation <span class="kr">AI ÏûêÎèô ÌòëÏÉÅ</span></h2><button class="modal-close" onclick="closeModal('negoModal')">&times;</button></div><div class="modal-body" id="negoModalBody"></div></div></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// USER ROLES & STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ROLES={BUYER:{id:'buyer',label:'Buyer',labelKr:'Íµ¨Îß§Ïûê',icon:'üõí',color:'#3b82f6'},SELLER:{id:'seller',label:'Seller',labelKr:'ÌåêÎß§Ïûê',icon:'üè∑Ô∏è',color:'#f97316'},LICENSOR:{id:'licensor',label:'Licensor',labelKr:'ÎùºÏù¥ÏÑºÏÑú',icon:'üìú',color:'#8b5cf6'},LICENSEE:{id:'licensee',label:'Licensee',labelKr:'ÎùºÏù¥ÏÑºÏãú',icon:'üîë',color:'#10b981'},MONITOR:{id:'monitor',label:'Monitor',labelKr:'Î™®ÎãàÌÑ∞',icon:'üëÅÔ∏è',color:'#6b7280'}};
let currentRole='buyer';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PATENT DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const patents=[
{id:"KR-2024-001234",title:"AI-Based Autonomous Driving Path Optimization",titleKr:"AI Í∏∞Î∞ò ÏûêÏú®Ï£ºÌñâ Í≤ΩÎ°ú ÏµúÏ†ÅÌôî",owner:"Samsung Electronics",ownerKr:"ÏÇºÏÑ±Ï†ÑÏûê",field:"AI",fieldKr:"Ïù∏Í≥µÏßÄÎä•",filingDate:"2024-03-15",status:"Granted",value:850000000,description:"Deep learning real-time autonomous driving path optimization.",descKr:"Îî•Îü¨Îãù ÏûêÏú®Ï£ºÌñâ Í≤ΩÎ°ú ÏµúÏ†ÅÌôî",claims:24,citedBy:15,remainingYears:17,techScore:92,marketScore:88,legalScore:95,isSEP:false,sepStandard:"",forSale:true,forLicense:true},
{id:"KR-2023-005678",title:"Quantum Cryptographic Communication Protocol",titleKr:"ÏñëÏûê ÏïîÌò∏Ìôî ÌÜµÏã† ÌîÑÎ°úÌÜ†ÏΩú",owner:"SK Telecom",ownerKr:"SKÌÖîÎ†àÏΩ§",field:"Security",fieldKr:"Î≥¥Ïïà/ÌÜµÏã†",filingDate:"2023-07-22",status:"Granted",value:1200000000,description:"QKD-based next-gen encrypted communication protocol.",descKr:"QKD Í∏∞Î∞ò Ï∞®ÏÑ∏ÎåÄ ÏïîÌò∏Ìôî ÌÜµÏã†",claims:18,citedBy:22,remainingYears:18,techScore:96,marketScore:82,legalScore:90,isSEP:true,sepStandard:"3GPP / ITU-T Q.810",forSale:true,forLicense:true},
{id:"KR-2024-009012",title:"Solid-State Battery Electrode Material",titleKr:"Í≥†Ï≤¥ Î∞∞ÌÑ∞Î¶¨ Ï†ÑÍ∑π ÏÜåÏû¨",owner:"LG Energy Solution",ownerKr:"LGÏóêÎÑàÏßÄÏÜîÎ£®ÏÖò",field:"Energy",fieldKr:"ÏóêÎÑàÏßÄ",filingDate:"2024-01-10",status:"Granted",value:2100000000,description:"Novel cathode for all-solid-state batteries, 2x density.",descKr:"Ï†ÑÍ≥†Ï≤¥ Î∞∞ÌÑ∞Î¶¨ ÏñëÍ∑πÏû¨",claims:32,citedBy:45,remainingYears:19,techScore:98,marketScore:95,legalScore:92,isSEP:false,sepStandard:"",forSale:false,forLicense:true},
{id:"KR-2023-003456",title:"Metaverse Spatial Rendering Engine",titleKr:"Î©îÌÉÄÎ≤ÑÏä§ Í≥µÍ∞Ñ Î†åÎçîÎßÅ ÏóîÏßÑ",owner:"Naver",ownerKr:"ÎÑ§Ïù¥Î≤Ñ",field:"Software",fieldKr:"ÏÜåÌîÑÌä∏Ïõ®Ïñ¥",filingDate:"2023-11-05",status:"Published",value:450000000,description:"Lightweight real-time 3D spatial rendering for mobile metaverse.",descKr:"Î™®Î∞îÏùº Î©îÌÉÄÎ≤ÑÏä§ 3D Î†åÎçîÎßÅ",claims:15,citedBy:8,remainingYears:18,techScore:78,marketScore:72,legalScore:85,isSEP:false,sepStandard:"",forSale:true,forLicense:true},
{id:"KR-2024-007890",title:"Genomic Biomarker Analysis Platform",titleKr:"Ïú†Ï†ÑÏ≤¥ Î∞îÏù¥Ïò§ÎßàÏª§ ÌîåÎû´Ìèº",owner:"Celltrion",ownerKr:"ÏÖÄÌä∏Î¶¨Ïò®",field:"Bio",fieldKr:"Î∞îÏù¥Ïò§",filingDate:"2024-05-20",status:"Granted",value:1750000000,description:"NGS-based multi-biomarker detection for cancer diagnosis.",descKr:"NGS Í∏∞Î∞ò Îã§Ï§ë Î∞îÏù¥Ïò§ÎßàÏª§ Í≤ÄÏ∂ú",claims:28,citedBy:35,remainingYears:19,techScore:94,marketScore:91,legalScore:88,isSEP:false,sepStandard:"",forSale:true,forLicense:true},
{id:"KR-2023-002345",title:"Smart Factory Digital Twin",titleKr:"Ïä§ÎßàÌä∏ Ìå©ÌÜ†Î¶¨ ÎîîÏßÄÌÑ∏ Ìä∏Ïúà",owner:"Hyundai Heavy",ownerKr:"ÌòÑÎåÄÏ§ëÍ≥µÏóÖ",field:"Manufacturing",fieldKr:"Ï†úÏ°∞/IoT",filingDate:"2023-09-12",status:"Granted",value:680000000,description:"Digital twin simulating entire manufacturing processes.",descKr:"Ï†úÏ°∞ Í≥µÏ†ï ÎîîÏßÄÌÑ∏ Ìä∏Ïúà",claims:20,citedBy:12,remainingYears:17,techScore:85,marketScore:80,legalScore:90,isSEP:false,sepStandard:"",forSale:true,forLicense:false},
{id:"KR-2024-004567",title:"6G Antenna Array Design",titleKr:"6G ÏïàÌÖåÎÇò Ïñ¥Î†àÏù¥ ÏÑ§Í≥Ñ",owner:"KT Corporation",ownerKr:"KT",field:"Telecom",fieldKr:"ÌÜµÏã†",filingDate:"2024-02-28",status:"Under Review",value:950000000,description:"Terahertz band compact antenna array for 6G.",descKr:"ÌÖåÎùºÌó§Î•¥Ï∏† 6G ÏïàÌÖåÎÇò",claims:22,citedBy:18,remainingYears:19,techScore:90,marketScore:76,legalScore:82,isSEP:true,sepStandard:"3GPP Release 20",forSale:false,forLicense:true},
{id:"KR-2023-008901",title:"Carbon Capture Catalyst Technology",titleKr:"ÌÉÑÏÜå Ìè¨Ïßë Ï¥âÎß§ Í∏∞Ïà†",owner:"POSCO",ownerKr:"Ìè¨Ïä§ÏΩî",field:"Environment",fieldKr:"ÌôòÍ≤Ω/ÏóêÎÑàÏßÄ",filingDate:"2023-06-30",status:"Granted",value:1350000000,description:"CO2 capture and conversion to high-value chemicals.",descKr:"CO2 Ìè¨Ïßë Î∞è ÌôîÌïôÏõêÎ£å Ï†ÑÌôò Ï¥âÎß§",claims:26,citedBy:30,remainingYears:18,techScore:88,marketScore:93,legalScore:87,isSEP:false,sepStandard:"",forSale:true,forLicense:true},
{id:"US-2024-031245",title:"5G NR MIMO Beamforming Method",titleKr:"5G NR MIMO ÎπîÌè¨Î∞ç",owner:"Qualcomm",ownerKr:"ÌÄÑÏª¥",field:"Telecom",fieldKr:"ÌÜµÏã†",filingDate:"2024-04-12",status:"Granted",value:3200000000,description:"Essential MIMO beamforming for 5G NR standard.",descKr:"5G NR ÌïÑÏàò MIMO ÎπîÌè¨Î∞ç",claims:35,citedBy:58,remainingYears:19,techScore:97,marketScore:96,legalScore:94,isSEP:true,sepStandard:"3GPP TS 38.214",forSale:true,forLicense:true},
{id:"EP-2023-087654",title:"Wi-Fi 7 Channel Access Protocol",titleKr:"Wi-Fi 7 Ï±ÑÎÑê Ï†ëÍ∑º ÌîÑÎ°úÌÜ†ÏΩú",owner:"Intel Corporation",ownerKr:"Ïù∏ÌÖî",field:"Telecom",fieldKr:"ÌÜµÏã†",filingDate:"2023-08-15",status:"Granted",value:1850000000,description:"MLO channel access for IEEE 802.11be Wi-Fi 7.",descKr:"IEEE 802.11be Wi-Fi 7 MLO Ï±ÑÎÑê Ï†ëÍ∑º",claims:29,citedBy:42,remainingYears:18,techScore:93,marketScore:90,legalScore:91,isSEP:true,sepStandard:"IEEE 802.11be",forSale:false,forLicense:true}
];

let transactions=[];
let activityFeed=[];
let currentPatent=null;let chartInstances={};let ohlcCache={};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI AGENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const aiAgents=[
{id:'agent-alpha',name:'AlphaPatent AI',avatar:'ü§ñ',bg:'#eff6ff',role:'buyer',strategy:'aggressive',budget:5e9,spent:0,interests:['Telecom','AI','Security'],minScore:80,maxPerDeal:2e9,royPref:'running',maxRoyRate:5,active:true,deals:0,desc:'Telecom & AI patent acquisition specialist. Aggressive bidding on high-value SEP.'},
{id:'agent-beta',name:'BetaLicense AI',avatar:'üß†',bg:'#f0fdf4',role:'licensee',strategy:'balanced',budget:2e9,spent:0,interests:['Energy','Bio','Environment'],minScore:75,maxPerDeal:5e8,royPref:'lumpsum',maxRoyRate:3.5,active:true,deals:0,desc:'Licensing specialist for green tech & biotech patents. Balanced approach.'},
{id:'agent-gamma',name:'GammaSeller AI',avatar:'‚ö°',bg:'#fef3c7',role:'seller',strategy:'conservative',budget:0,spent:0,interests:['Software','Manufacturing','AI'],minScore:0,maxPerDeal:0,royPref:'',maxRoyRate:0,active:true,deals:0,desc:'Optimizes patent sale timing using market trend analysis. Conservative pricing.'},
{id:'agent-delta',name:'DeltaBroker AI',avatar:'üîÑ',bg:'#faf5ff',role:'broker',strategy:'balanced',budget:10e9,spent:0,interests:['Telecom','Energy','AI','Security','Bio'],minScore:70,maxPerDeal:3e9,royPref:'running',maxRoyRate:4,active:true,deals:0,desc:'Full-service broker matching buyers & sellers. Cross-industry deal facilitation.'},
{id:'agent-omega',name:'OmegaMonitor AI',avatar:'üìä',bg:'#f1f5f9',role:'monitor',strategy:'conservative',budget:0,spent:0,interests:['Telecom','AI','Energy','Bio','Security','Software','Manufacturing','Environment'],minScore:0,maxPerDeal:0,royPref:'',maxRoyRate:0,active:true,deals:0,desc:'Market surveillance & patent valuation analyst. Provides alerts and insights.'}
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function fUSD(v){if(v>=1e9)return'$'+(v/1e9).toFixed(2)+'B';if(v>=1e6)return'$'+(v/1e6).toFixed(1)+'M';if(v>=1e3)return'$'+(v/1e3).toFixed(0)+'K';return'$'+v;}
function fKRW(v){if(v>=1e8)return(v/1e8).toFixed(1)+'ÏñµÏõê';if(v>=1e4)return(v/1e4).toFixed(0)+'ÎßåÏõê';return v+'Ïõê';}
function fKRW2(v){if(v>=1e8)return(v/1e8).toFixed(2)+'Ïñµ';if(v>=1e4)return(v/1e4).toFixed(0)+'Îßå';return v+'';}
function fVal(v){return fUSD(v)+' <span style="color:var(--gray-400);font-size:.8em">('+fKRW(v)+')</span>';}
function badge(t,c){return`<span class="badge badge-${c}">${t}</span>`;}
function statusBadge(s){return badge(s,{Granted:'green',Published:'blue','Under Review':'amber'}[s]||'gray');}
function sepBadge(p){return p.isSEP?`<span class="badge-sep">SEP</span>`:'';}
function sepInd(p){return p.isSEP?`<div class="sep-indicator">‚òÖ SEP${p.sepStandard?' ‚Äî '+p.sepStandard:''}</div>`:'';}
function typeBadge(t){return badge(t,t==='Trade'?'purple':'blue');}
function txBadge(s){return badge(s,{Completed:'green','In Progress':'amber',Negotiating:'gray',Rejected:'red','AI Auto':'purple'}[s]||'gray');}
function roleBadge(r){const m={buyer:'blue',seller:'amber',licensor:'purple',licensee:'green',broker:'purple',monitor:'gray'};return badge(r,m[r]||'gray');}
function notify(m,t='success'){const e=document.getElementById('notification');e.textContent=m;e.className=`notification ${t} show`;setTimeout(()=>e.className='notification',3500);}
function openModal(id){document.getElementById(id).classList.add('show');}
function closeModal(id){document.getElementById(id).classList.remove('show');}
function destroyChart(n){if(chartInstances[n]){chartInstances[n].destroy();delete chartInstances[n];}}
function updateTV(){document.getElementById('totalValue').textContent=fUSD(patents.reduce((s,p)=>s+p.value,0));}
function timeAgo(d){const s=Math.floor((Date.now()-d)/1000);if(s<60)return s+'s ago';if(s<3600)return Math.floor(s/60)+'m ago';if(s<86400)return Math.floor(s/3600)+'h ago';return Math.floor(s/86400)+'d ago';}
function addFeed(icon,bg,title,desc,agentId){activityFeed.unshift({icon,bg,title,desc,time:Date.now(),agentId});if(activityFeed.length>100)activityFeed.pop();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OHLC & CANDLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function genOHLC(bv,days,seed){const d=[];let pr=bv/1e8;const rng=s=>{s=Math.sin(s)*10000;return s-Math.floor(s);};for(let i=0;i<days;i++){const r1=rng(seed+i*7.3),r2=rng(seed+i*13.7+100),r3=rng(seed+i*23.1+200),r4=rng(seed+i*37.9+300);const ch=(r1-.48)*pr*.06;const o=pr,c=pr+ch;const h=Math.max(o,c)+Math.abs(r2*pr*.025);const l=Math.min(o,c)-Math.abs(r3*pr*.025);const v=Math.floor(50+r4*200);const dt=new Date(2026,1,8);dt.setDate(dt.getDate()-(days-i));d.push({date:dt,open:+o.toFixed(2),high:+h.toFixed(2),low:+l.toFixed(2),close:+c.toFixed(2),volume:v});pr=c;}return d;}
function aggOHLC(daily,period){if(period==='daily')return daily;const g={};daily.forEach(d=>{let k;if(period==='weekly'){const sw=new Date(d.date);sw.setDate(d.date.getDate()-d.date.getDay());k=sw.toISOString().slice(0,10);}else k=d.date.getFullYear()+'-'+String(d.date.getMonth()+1).padStart(2,'0');if(!g[k])g[k]=[];g[k].push(d);});return Object.values(g).map(x=>({date:x[0].date,open:x[0].open,high:Math.max(...x.map(d=>d.high)),low:Math.min(...x.map(d=>d.low)),close:x[x.length-1].close,volume:x.reduce((s,d)=>s+d.volume,0)}));}
function getOHLC(p){if(!ohlcCache[p.id]){const s=p.id.split('').reduce((a,c)=>a+c.charCodeAt(0),0);ohlcCache[p.id]=genOHLC(p.value,365,s);}return ohlcCache[p.id];}
function calcMA(d,p){return d.map((x,i)=>i<p-1?null:+(d.slice(i-p+1,i+1).reduce((s,v)=>s+v.close,0)/p).toFixed(2));}
function drawCandle(cid,data,opts={}){const cv=document.getElementById(cid);if(!cv)return;const ctx=cv.getContext('2d');const dpr=window.devicePixelRatio||1;const W=cv.parentElement.getBoundingClientRect().width;const H=opts.height||400;cv.width=W*dpr;cv.height=H*dpr;cv.style.width=W+'px';cv.style.height=H+'px';ctx.scale(dpr,dpr);if(!data||!data.length)return;const pad={top:10,right:65,bottom:50,left:10};const cH=H-pad.top-pad.bottom;const vH=cH*.18;const pH=cH-vH-8;const prices=data.flatMap(d=>[d.high,d.low]);let minP=Math.min(...prices),maxP=Math.max(...prices);const pR=maxP-minP||1;minP-=pR*.05;maxP+=pR*.05;const maxV=Math.max(...data.map(d=>d.volume));const cW=Math.max(2,Math.min(12,(W-pad.left-pad.right)/data.length*.7));const gap=(W-pad.left-pad.right)/data.length;const pY=p=>pad.top+pH-((p-minP)/(maxP-minP))*pH;const vY=v=>pad.top+pH+8+vH-(v/maxV)*vH;const cX=i=>pad.left+gap*i+gap/2;ctx.fillStyle='#111827';ctx.fillRect(0,0,W,H);ctx.strokeStyle='#1f2937';ctx.lineWidth=.5;for(let i=0;i<=5;i++){const y=pad.top+(pH/5)*i;ctx.beginPath();ctx.moveTo(pad.left,y);ctx.lineTo(W-pad.right,y);ctx.stroke();ctx.fillStyle='#6b7280';ctx.font='9px sans-serif';ctx.textAlign='left';ctx.fillText(fKRW2((maxP-((maxP-minP)/5)*i)*1e8),W-pad.right+4,y+3);}data.forEach((d,i)=>{const x=cX(i);ctx.fillStyle=d.close>=d.open?'rgba(34,197,94,.25)':'rgba(239,68,68,.25)';const vy=vY(d.volume);ctx.fillRect(x-cW/2,vy,cW,pad.top+pH+8+vH-vy);});const ma5=calcMA(data,5),ma20=calcMA(data,20),ma60=calcMA(data,Math.min(60,data.length));[[ma5,'#f59e0b'],[ma20,'#3b82f6'],[ma60,'#ec4899']].forEach(([ma,col])=>{ctx.strokeStyle=col;ctx.lineWidth=1;ctx.beginPath();let st=false;ma.forEach((v,i)=>{if(v===null)return;const x=cX(i),y=pY(v);if(!st){ctx.moveTo(x,y);st=true;}else ctx.lineTo(x,y);});ctx.stroke();});data.forEach((d,i)=>{const x=cX(i);const up=d.close>=d.open;const col=up?'#22c55e':'#ef4444';ctx.strokeStyle=col;ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(x,pY(d.high));ctx.lineTo(x,pY(d.low));ctx.stroke();const bT=pY(Math.max(d.open,d.close)),bB=pY(Math.min(d.open,d.close)),bH=Math.max(1,bB-bT);if(up){ctx.strokeStyle=col;ctx.lineWidth=1;ctx.strokeRect(x-cW/2,bT,cW,bH);}else{ctx.fillStyle=col;ctx.fillRect(x-cW/2,bT,cW,bH);}});ctx.fillStyle='#6b7280';ctx.font='8px sans-serif';ctx.textAlign='center';const step=Math.max(1,Math.floor(data.length/8));data.forEach((d,i)=>{if(i%step===0)ctx.fillText((d.date.getMonth()+1)+'/'+d.date.getDate(),cX(i),H-pad.bottom+14);});cv._ohlcData=data;cv._meta={pad,pH,vH,gap,cX,pY,W,H,minP,maxP,maxV};}
function setupHover(cid,iid){const cv=document.getElementById(cid);if(!cv)return;cv.addEventListener('mousemove',e=>{const r=cv.getBoundingClientRect();const mx=e.clientX-r.left;const d=cv._ohlcData,m=cv._meta;if(!d||!m)return;const idx=Math.round((mx-m.pad.left-m.gap/2)/m.gap);if(idx<0||idx>=d.length)return;const x=d[idx];const up=x.close>=x.open;const ch=((x.close-x.open)/x.open*100).toFixed(2);const dt=x.date;const ds=dt.getFullYear()+'.'+String(dt.getMonth()+1).padStart(2,'0')+'.'+String(dt.getDate()).padStart(2,'0');const cl=up?'up':'down';const info=document.getElementById(iid);if(info)info.innerHTML=`<span>${ds}</span><span>O <span class="${cl}">${fKRW2(x.open*1e8)}</span></span><span>H <span class="${cl}">${fKRW2(x.high*1e8)}</span></span><span>L <span class="${cl}">${fKRW2(x.low*1e8)}</span></span><span>C <span class="${cl}">${fKRW2(x.close*1e8)}</span></span><span>${ch>=0?'+':''}${ch}%</span>`;});}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI ENGINE ‚Äî Valuation, Matching, Recommendation
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const AIEngine={
  // Score a patent for a given agent
  scoreForAgent(patent,agent){
    if(!agent.interests.some(i=>patent.field.includes(i)||i.includes(patent.field)))return 0;
    const avg=(patent.techScore+patent.marketScore+patent.legalScore)/3;
    if(avg<agent.minScore)return 0;
    let score=avg;
    if(patent.isSEP)score+=15;
    if(patent.remainingYears>15)score+=5;
    if(patent.citedBy>20)score+=5;
    if(agent.strategy==='aggressive')score+=10;
    if(agent.strategy==='conservative')score-=5;
    const budget_ok=(agent.role==='seller'||agent.role==='monitor')?true:patent.value<=agent.maxPerDeal;
    return budget_ok?Math.min(100,Math.round(score)):0;
  },

  // Get recommendations for current role
  getRecommendations(role){
    const recs=[];
    if(role==='buyer'){
      patents.filter(p=>p.forSale).forEach(p=>{
        const bestAgent=aiAgents.filter(a=>a.role==='buyer'&&a.active).map(a=>({a,s:this.scoreForAgent(p,a)})).sort((a,b)=>b.s-a.s)[0];
        if(bestAgent&&bestAgent.s>60)recs.push({type:'buy',patent:p,agent:bestAgent.a,score:bestAgent.s,reason:p.isSEP?'High-value SEP with strong market position':'Strong tech score ('+p.techScore+') in growing market',action:'Initiate Trade'});
      });
    }else if(role==='seller'){
      patents.forEach(p=>{
        const buyers=aiAgents.filter(a=>(a.role==='buyer'||a.role==='broker')&&a.active);
        const demand=buyers.reduce((s,a)=>s+this.scoreForAgent(p,a),0)/Math.max(1,buyers.length);
        if(demand>50)recs.push({type:'sell',patent:p,score:Math.round(demand),reason:'High demand from '+buyers.filter(a=>this.scoreForAgent(p,a)>50).length+' AI agents',action:'List for Sale'});
      });
    }else if(role==='licensor'){
      patents.filter(p=>p.forLicense).forEach(p=>{
        const licensees=aiAgents.filter(a=>a.role==='licensee'&&a.active);
        const interest=licensees.reduce((s,a)=>s+this.scoreForAgent(p,a),0)/Math.max(1,licensees.length);
        if(interest>40)recs.push({type:'license_out',patent:p,score:Math.round(interest),reason:p.isSEP?'SEP licensing opportunity ‚Äî FRAND terms applicable':'Multiple licensee agents interested',action:'Offer License'});
      });
    }else if(role==='licensee'){
      patents.filter(p=>p.forLicense).forEach(p=>{
        const bestAgent=aiAgents.filter(a=>a.role==='licensee'&&a.active).map(a=>({a,s:this.scoreForAgent(p,a)})).sort((a,b)=>b.s-a.s)[0];
        if(bestAgent&&bestAgent.s>50)recs.push({type:'license_in',patent:p,agent:bestAgent.a,score:bestAgent.s,reason:'Matches portfolio strategy: '+bestAgent.a.interests.join(', '),action:'Request License'});
      });
    }else{
      const topPatents=[...patents].sort((a,b)=>b.value-a.value).slice(0,5);
      topPatents.forEach(p=>recs.push({type:'watch',patent:p,score:Math.round((p.techScore+p.marketScore+p.legalScore)/3),reason:'Top value patent ‚Äî monitor for price movements',action:'View Chart'}));
    }
    return recs.sort((a,b)=>b.score-a.score).slice(0,6);
  },

  // Auto-match: find best agent pairs for deals
  findMatches(){
    const matches=[];
    const buyers=aiAgents.filter(a=>(a.role==='buyer'||a.role==='broker')&&a.active);
    const sellers=aiAgents.filter(a=>(a.role==='seller'||a.role==='broker')&&a.active);
    const licensees=aiAgents.filter(a=>(a.role==='licensee'||a.role==='broker')&&a.active);
    patents.forEach(p=>{
      if(p.forSale){buyers.forEach(b=>{const bs=this.scoreForAgent(p,b);if(bs>65)matches.push({type:'trade',patent:p,buyerAgent:b,score:bs})});}
      if(p.forLicense){licensees.forEach(l=>{const ls=this.scoreForAgent(p,l);if(ls>55)matches.push({type:'license',patent:p,licenseeAgent:l,score:ls})});}
    });
    return matches.sort((a,b)=>b.score-a.score);
  },

  // Simulate negotiation steps
  negotiate(match){
    const steps=[];const p=match.patent;const agent=match.buyerAgent||match.licenseeAgent;
    const isAggressive=agent.strategy==='aggressive';const isConservative=agent.strategy==='conservative';
    // Step 1: Valuation
    steps.push({title:'AI Valuation Analysis',desc:`${agent.name} analyzed ${p.title}. Composite score: ${this.scoreForAgent(p,agent)}/100. Tech: ${p.techScore}, Market: ${p.marketScore}, Legal: ${p.legalScore}.`,status:'done'});
    // Step 2: Initial Offer
    const discount=isAggressive?0.95:isConservative?0.75:0.85;
    const offer=Math.round(p.value*discount);
    steps.push({title:'Initial Offer Submitted',desc:`${agent.name} offered ${fUSD(offer)} (${Math.round(discount*100)}% of valuation ${fUSD(p.value)}).`,status:'done'});
    // Step 3: Counter
    const counter=Math.round(p.value*(isConservative?0.95:0.92));
    steps.push({title:'Counter-Offer Received',desc:`Patent owner countered at ${fUSD(counter)}.`,status:'done'});
    // Step 4: Final
    const final=Math.round((offer+counter)/2);
    steps.push({title:'Final Negotiation',desc:`${agent.name} proposed split at ${fUSD(final)}. ${isAggressive?'Accepted quickly.':'Further review in progress.'}`,status:isAggressive?'done':'active'});
    // Step 5: Close
    if(isAggressive||agent.strategy==='balanced'){
      steps.push({title:'Deal Closed',desc:`${match.type==='trade'?'Trade':'License'} agreement at ${fUSD(final)}. Transaction recorded.`,status:isAggressive?'done':'active'});
    }else{
      steps.push({title:'Under Review',desc:'Conservative agent reviewing terms. Expected 24-48h.', status:'pending'});
    }
    return{steps,finalPrice:final};
  },

  // Run auto-trading cycle
  runAutoCycle(){
    const matches=this.findMatches().slice(0,3);
    let dealsCompleted=0;
    matches.forEach(m=>{
      const agent=m.buyerAgent||m.licenseeAgent;
      if(!agent||!agent.active)return;
      const nego=this.negotiate(m);
      const allDone=nego.steps.every(s=>s.status==='done');
      if(allDone){
        const txType=m.type==='trade'?'Trade':'License';
        transactions.push({id:transactions.length+1,patentId:m.patent.id,type:txType,buyer:agent.name,amount:nego.finalPrice,date:new Date().toISOString().slice(0,10),status:'AI Auto',agentId:agent.id,isAI:true});
        agent.deals++;agent.spent+=nego.finalPrice;dealsCompleted++;
        addFeed(agent.avatar,agent.bg,`${agent.name} ‚Äî ${txType}`,`${txType} completed: ${m.patent.title} at ${fUSD(nego.finalPrice)}`,agent.id);
      }else{
        addFeed(agent.avatar,agent.bg,`${agent.name} ‚Äî Negotiating`,`${m.type} negotiation in progress: ${m.patent.title}`,agent.id);
      }
    });
    if(dealsCompleted>0)notify(`AI Agents completed ${dealsCompleted} deal(s) automatically!`,'info');
    return dealsCompleted;
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ROLE-BASED NAV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setRole(r){currentRole=r;renderRoleSelector();renderNav();switchTab('dashboard');}
function renderRoleSelector(){
  document.getElementById('roleSelector').innerHTML=Object.values(ROLES).map(r=>`<button class="role-btn${currentRole===r.id?' active':''}" onclick="setRole('${r.id}')"><span class="role-icon">${r.icon}</span>${r.label}</button>`).join('');
}
const tabDefs=[
  {id:'dashboard',label:'Dashboard',kr:'ÎåÄÏãúÎ≥¥Îìú',icon:'<rect x="3" y="3" width="7" height="9" rx="1"/><rect x="14" y="3" width="7" height="5" rx="1"/><rect x="14" y="12" width="7" height="9" rx="1"/><rect x="3" y="16" width="7" height="5" rx="1"/>',roles:['buyer','seller','licensor','licensee','monitor']},
  {id:'patents',label:'Patents',kr:'ÌäπÌóà Î™©Î°ù',icon:'<path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>',roles:['buyer','seller','licensor','licensee','monitor']},
  {id:'agents',label:'AI Agents',kr:'AI ÏóêÏù¥Ï†ÑÌä∏',icon:'<circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>',roles:['buyer','seller','licensor','licensee','monitor']},
  {id:'chart',label:'Value Chart',kr:'Í∞ÄÏπò Ï∞®Ìä∏',icon:'<path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/>',roles:['buyer','seller','licensor','licensee','monitor']},
  {id:'value',label:'Analysis',kr:'Í∞ÄÏπò Î∂ÑÏÑù',icon:'<path d="M18 20V10M12 20V4M6 20v-6"/>',roles:['buyer','seller','licensor','licensee','monitor']},
  {id:'transactions',label:'Transactions',kr:'Í±∞Îûò ÎÇ¥Ïó≠',icon:'<path d="M17 1l4 4-4 4"/><path d="M3 11V9a4 4 0 014-4h14"/><path d="M7 23l-4-4 4-4"/><path d="M21 13v2a4 4 0 01-4 4H3"/>',roles:['buyer','seller','licensor','licensee','monitor']}
];
let activeTab='dashboard';
function renderNav(){
  const tabs=tabDefs.filter(t=>t.roles.includes(currentRole));
  document.getElementById('navTabs').innerHTML=tabs.map(t=>`<button class="tab-btn${activeTab===t.id?' active':''}" onclick="switchTab('${t.id}')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">${t.icon}</svg>${t.label}<span class="kr">${t.kr}</span></button>`).join('');
}
function switchTab(tab){activeTab=tab;document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));const el=document.getElementById('tab-'+tab);if(el)el.classList.add('active');renderNav();({dashboard:renderDashboard,patents:renderPatents,agents:renderAgents,chart:renderChartTab,value:renderValue,transactions:renderTransactions})[tab]?.();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD (role-based)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDashboard(){
  const tv=patents.reduce((s,p)=>s+p.value,0);updateTV();
  const sepC=patents.filter(p=>p.isSEP).length;
  const aiDeals=transactions.filter(t=>t.isAI).length;
  const activeAgents=aiAgents.filter(a=>a.active).length;
  const recs=AIEngine.getRecommendations(currentRole);
  const R=ROLES[currentRole.toUpperCase()];

  let h=`<div style="margin-bottom:16px;display:flex;align-items:center;gap:10px">
    <span style="font-size:28px">${R.icon}</span>
    <div><div style="font-size:18px;font-weight:800">${R.label} Dashboard</div>
    <div style="font-size:12px;color:var(--gray-400)">${R.labelKr} ÎåÄÏãúÎ≥¥Îìú ¬∑ AI-powered insights for ${R.label.toLowerCase()}s</div></div>
  </div>
  <div class="stat-grid">
    <div class="stat-card bg-navy"><div class="label">Total Patents <span class="emoji">üìã</span></div><div class="val">${patents.length}<span class="unit">ea</span></div><div class="kr-sub">Ï¥ù ÌäπÌóà Ïàò</div></div>
    <div class="stat-card bg-emerald"><div class="label">Portfolio Value <span class="emoji">üíé</span></div><div class="val">${fUSD(tv)}</div><div class="kr-sub">${fKRW(tv)}</div></div>
    <div class="stat-card bg-amber"><div class="label">SEP Patents <span class="emoji">‚òÖ</span></div><div class="val">${sepC}</div><div class="kr-sub">ÌëúÏ§ÄÌïÑÏàòÌäπÌóà</div></div>
    <div class="stat-card bg-purple"><div class="label">AI Agents <span class="emoji">ü§ñ</span></div><div class="val">${activeAgents}<span class="unit">active</span></div><div class="kr-sub">ÌôúÏÑ± AI ÏóêÏù¥Ï†ÑÌä∏</div></div>
    <div class="stat-card bg-cyan"><div class="label">AI Deals <span class="emoji">‚ö°</span></div><div class="val">${aiDeals}</div><div class="kr-sub">AI ÏûêÎèô Í±∞Îûò</div></div>
  </div>`;

  // AI Recommendations
  if(recs.length){
    h+=`<div class="card"><h3>ü§ñ AI Recommendations <span class="kr">AI Ï∂îÏ≤ú</span></h3>`;
    recs.forEach(r=>{
      h+=`<div class="rec-card"><h4><span class="rec-score">${r.score}/100</span> ${r.patent.title} ${r.patent.isSEP?'<span class="badge-sep">SEP</span>':''}</h4>
      <p>${r.reason} ¬∑ Value: <strong>${fUSD(r.patent.value)}</strong>${r.agent?' ¬∑ Agent: '+r.agent.name:''}</p>
      <div class="rec-action">
        <button class="btn btn-primary" onclick="${r.type==='buy'?"openTrade('"+r.patent.id+"')":r.type==='watch'?"openCandleModal('"+r.patent.id+"')":"openLicense('"+r.patent.id+"')"}">${r.action}</button>
        <button class="btn btn-outline" onclick="openDetail('${r.patent.id}')">Details</button>
        ${r.agent?`<button class="btn btn-purple" onclick="runAgentNego('${r.patent.id}','${r.agent.id}')">ü§ñ AI Auto-Deal</button>`:''}
      </div></div>`;
    });
    h+=`</div>`;
  }

  // Activity Feed
  h+=`<div class="chart-row"><div class="card"><h3>üìä Market Overview <span class="kr">ÏãúÏû• Í∞úÏöî</span></h3><div class="chart-container"><canvas id="cDashBar"></canvas></div></div>
  <div class="card"><h3>‚ö° AI Agent Activity <span class="kr">ÏóêÏù¥Ï†ÑÌä∏ ÌôúÎèô</span></h3>`;
  if(!activityFeed.length)h+=`<div style="text-align:center;color:var(--gray-400);padding:30px;font-size:12px">No activity yet. Click "Run AI Cycle" in the Agents tab to start.<br><span style="font-size:11px">ÏïÑÏßÅ ÌôúÎèô ÏóÜÏùå. AI ÏóêÏù¥Ï†ÑÌä∏ ÌÉ≠ÏóêÏÑú ÏûêÎèô Îß§Ïπ≠ÏùÑ Ïã§ÌñâÌïòÏÑ∏Ïöî.</span></div>`;
  else activityFeed.slice(0,8).forEach(f=>{h+=`<div class="feed-item"><div class="feed-icon" style="background:${f.bg}">${f.icon}</div><div class="feed-content"><div class="feed-title">${f.title}</div><div class="feed-desc">${f.desc}</div></div><div class="feed-time">${timeAgo(f.time)}</div></div>`;});
  h+=`</div></div>`;

  // Recent transactions
  h+=`<div class="card"><h3>Recent Transactions <span class="kr">ÏµúÍ∑º Í±∞Îûò</span></h3>`;
  if(!transactions.length)h+=`<p style="text-align:center;color:var(--gray-400);padding:20px;font-size:12px">No transactions yet.</p>`;
  else{h+=`<table><thead><tr><th>Patent</th><th>Type</th><th>Counterparty</th><th>Amount</th><th>Date</th><th>Status</th></tr></thead><tbody>`;
  transactions.slice(-6).reverse().forEach(tx=>{h+=`<tr><td class="mono">${tx.patentId}</td><td>${typeBadge(tx.type)}</td><td>${tx.buyer}${tx.isAI?' ü§ñ':''}</td><td style="font-weight:700">${fUSD(tx.amount)}</td><td style="color:var(--gray-500)">${tx.date}</td><td>${txBadge(tx.status)}</td></tr>`;});
  h+=`</tbody></table>`;}
  h+=`</div>`;

  document.getElementById('tab-dashboard').innerHTML=h;
  // Chart
  const fm={};patents.forEach(p=>{const f=p.field;fm[f]=(fm[f]||0)+p.value;});
  const fl=Object.keys(fm),fv=fl.map(f=>fm[f]),colors=['#1e3a5f','#06b6d4','#10b981','#f59e0b','#ef4444','#8b5cf6','#ec4899','#14b8a6'];
  destroyChart('dBar');chartInstances.dBar=new Chart(document.getElementById('cDashBar'),{type:'bar',data:{labels:fl,datasets:[{label:'Value',data:fv,backgroundColor:colors,borderRadius:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{ticks:{callback:v=>fUSD(v)}}}}});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PATENTS LIST (role-aware)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let sepFilterOn=false;
function renderPatents(){
  const fields=['All',...new Set(patents.map(p=>p.field))];
  const sts=['All','Granted','Published','Under Review'];
  const R=ROLES[currentRole.toUpperCase()];
  let h=`<div class="card" style="margin-bottom:14px;padding:14px 18px">
    <div class="filter-bar">
      <input type="text" id="searchInput" placeholder="Search patents..." oninput="filterPatents()">
      <select id="fieldFilter" onchange="filterPatents()">${fields.map(f=>`<option>${f}</option>`).join('')}</select>
      <select id="statusFilter" onchange="filterPatents()">${sts.map(s=>`<option>${s}</option>`).join('')}</select>
      <div class="sep-filter${sepFilterOn?' active':''}" onclick="sepFilterOn=!sepFilterOn;renderPatents()">‚òÖ SEP</div>
      <span style="font-size:11px;color:var(--gray-500)" id="filterCount">${patents.length}</span>
      ${currentRole!=='monitor'?`<button class="btn btn-orange" onclick="openUploadModal()">+ Register</button>`:''}
    </div>
  </div><div id="patentList"></div>`;
  document.getElementById('tab-patents').innerHTML=h;filterPatents();
}
function filterPatents(){
  const q=(document.getElementById('searchInput')?.value||'').toLowerCase();
  const ff=document.getElementById('fieldFilter')?.value||'All';
  const sf=document.getElementById('statusFilter')?.value||'All';
  const filtered=patents.filter(p=>{
    const mq=!q||p.title.toLowerCase().includes(q)||p.titleKr.includes(q)||p.owner.toLowerCase().includes(q)||p.id.toLowerCase().includes(q)||p.field.toLowerCase().includes(q);
    const mf=ff==='All'||p.field===ff;const ms=sf==='All'||p.status===sf;const msep=!sepFilterOn||p.isSEP;
    return mq&&mf&&ms&&msep;
  });
  document.getElementById('filterCount').textContent=filtered.length+' patents';
  const isBuyer=currentRole==='buyer';const isSeller=currentRole==='seller';const isLicensor=currentRole==='licensor';const isLicensee=currentRole==='licensee';const isMon=currentRole==='monitor';
  document.getElementById('patentList').innerHTML=filtered.map(p=>{
    let btns=`<button class="btn btn-outline" onclick="openDetail('${p.id}')">Details</button><button class="btn btn-outline" onclick="openCandleModal('${p.id}')" style="color:var(--amber-d)">üìà</button>`;
    if(isBuyer&&p.forSale)btns+=`<button class="btn btn-primary" onclick="openTrade('${p.id}')">Buy</button>`;
    if(isSeller)btns+=`<button class="btn btn-orange" onclick="openTrade('${p.id}')">Sell</button>`;
    if(isLicensor&&p.forLicense)btns+=`<button class="btn btn-emerald" onclick="openLicense('${p.id}')">Offer License</button>`;
    if(isLicensee&&p.forLicense)btns+=`<button class="btn btn-emerald" onclick="openLicense('${p.id}')">Request License</button>`;
    if(!isMon)btns+=`<button class="btn btn-purple" onclick="autoAgentDeal('${p.id}')">ü§ñ AI</button>`;
    return`<div class="patent-item${p.isSEP?' is-sep':''}"><div class="patent-header">
      <div class="patent-info">
        <div class="patent-meta"><span class="mono">${p.id}</span>${statusBadge(p.status)}${sepBadge(p)}${badge(p.field,'gray')}${p.forSale?badge('For Sale','green'):''}${p.forLicense?badge('Licensable','blue'):''}</div>
        <div class="patent-title" onclick="openDetail('${p.id}')">${p.title}</div>
        <div class="patent-title-kr">${p.titleKr}</div>
        <div class="patent-sub">Owner: <strong>${p.owner}</strong> (${p.ownerKr}) ¬∑ Claims: ${p.claims} ¬∑ Cited: ${p.citedBy}</div>
        ${p.isSEP?`<div style="margin:4px 0">${sepInd(p)}</div>`:''}
        <div class="patent-desc">${p.description}</div>
      </div>
      <div class="patent-actions">
        <div class="patent-value">${fUSD(p.value)}</div>
        <div style="font-size:10px;color:var(--gray-400)">${fKRW(p.value)}</div>
        <div class="btn-group">${btns}</div>
      </div>
    </div></div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI AGENTS TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAgents(){
  const matches=AIEngine.findMatches();
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px">
    <div><div style="font-size:18px;font-weight:800">ü§ñ AI Agent Hub <span style="font-size:12px;color:var(--gray-400);font-weight:500">AI ÏóêÏù¥Ï†ÑÌä∏ ÌóàÎ∏å</span></div>
    <div style="font-size:11px;color:var(--gray-500)">Autonomous trading, licensing & monitoring agents ¬∑ ÏûêÏú® Í±∞Îûò/ÎùºÏù¥ÏÑºÏã±/Î™®ÎãàÌÑ∞ÎßÅ ÏóêÏù¥Ï†ÑÌä∏</div></div>
    <div style="display:flex;gap:6px">
      <button class="btn btn-primary" onclick="runAICycle()">‚ö° Run AI Cycle</button>
      <button class="btn btn-purple" onclick="runAllMatches()">üîÑ Auto-Match All</button>
    </div>
  </div>`;

  // Agent cards
  h+=`<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:14px;margin-bottom:20px">`;
  aiAgents.forEach(a=>{
    h+=`<div class="agent-card ${a.active?'agent-active':'agent-paused'}">
      <div class="agent-header">
        <div class="agent-avatar" style="background:${a.bg}">${a.avatar}</div>
        <div class="agent-info">
          <div class="agent-name">${a.name} ${a.active?'<span style="color:var(--emerald);font-size:10px">‚óè Active</span>':'<span style="color:var(--gray-400);font-size:10px">‚óè Paused</span>'}</div>
          <div class="agent-type">${roleBadge(a.role)} ${badge(a.strategy,a.strategy==='aggressive'?'red':a.strategy==='conservative'?'blue':'green')} ¬∑ ${a.interests.join(', ')}</div>
          <div style="font-size:10px;color:var(--gray-500);margin-top:4px">${a.desc}</div>
        </div>
      </div>
      <div class="agent-stats">
        ${a.role!=='monitor'&&a.role!=='seller'?`<div class="agent-stat"><div class="as-val">${fUSD(a.budget-a.spent)}</div><div class="as-label">Budget Left</div></div>`:''}
        <div class="agent-stat"><div class="as-val">${a.deals}</div><div class="as-label">Deals</div></div>
        ${a.role!=='monitor'&&a.role!=='seller'?`<div class="agent-stat"><div class="as-val">${fUSD(a.spent)}</div><div class="as-label">Spent</div></div>`:''}
        <div class="agent-stat"><div class="as-val">${a.minScore||'N/A'}</div><div class="as-label">Min Score</div></div>
      </div>
      <div class="agent-actions-bar">
        <button class="btn ${a.active?'btn-gray':'btn-emerald'}" onclick="toggleAgent('${a.id}')">${a.active?'Pause':'Activate'}</button>
        <button class="btn btn-outline" onclick="viewAgentDetail('${a.id}')">Detail</button>
        <button class="btn btn-purple" onclick="runSingleAgent('${a.id}')">‚ö° Run</button>
      </div>
    </div>`;
  });
  h+=`</div>`;

  // Potential matches
  h+=`<div class="card"><h3>üîÑ AI Match Results <span class="kr">AI ÏûêÎèô Îß§Ïπ≠ Í≤∞Í≥º</span></h3>`;
  if(!matches.length)h+=`<p style="text-align:center;color:var(--gray-400);padding:20px;font-size:12px">No matches found. Adjust agent parameters or add more patents.</p>`;
  else{
    h+=`<table><thead><tr><th>Type</th><th>Patent</th><th>Agent</th><th>Score</th><th>Est. Price</th><th>Action</th></tr></thead><tbody>`;
    matches.slice(0,10).forEach(m=>{
      const agent=m.buyerAgent||m.licenseeAgent;
      const est=Math.round(m.patent.value*(agent.strategy==='aggressive'?0.95:agent.strategy==='conservative'?0.85:0.9));
      h+=`<tr><td>${typeBadge(m.type==='trade'?'Trade':'License')}</td><td style="font-weight:600;font-size:11px">${m.patent.title.slice(0,30)}${m.patent.isSEP?' ‚òÖ':''}</td><td><span style="font-size:14px">${agent.avatar}</span> ${agent.name}</td><td><span class="rec-score">${m.score}</span></td><td style="font-weight:700">${fUSD(est)}</td><td><button class="btn btn-purple" onclick="runAgentNego('${m.patent.id}','${agent.id}')">ü§ñ Negotiate</button></td></tr>`;
    });
    h+=`</tbody></table>`;}
  h+=`</div>`;

  // Activity log
  h+=`<div class="card"><h3>üìã Agent Activity Log <span class="kr">ÏóêÏù¥Ï†ÑÌä∏ ÌôúÎèô Î°úÍ∑∏</span></h3>`;
  if(!activityFeed.length)h+=`<p style="text-align:center;color:var(--gray-400);padding:20px;font-size:12px">No activity yet. Run AI Cycle to start.</p>`;
  else activityFeed.slice(0,15).forEach(f=>{h+=`<div class="feed-item"><div class="feed-icon" style="background:${f.bg}">${f.icon}</div><div class="feed-content"><div class="feed-title">${f.title}</div><div class="feed-desc">${f.desc}</div></div><div class="feed-time">${timeAgo(f.time)}</div></div>`;});
  h+=`</div>`;

  document.getElementById('tab-agents').innerHTML=h;
}

function toggleAgent(id){const a=aiAgents.find(x=>x.id===id);if(a){a.active=!a.active;notify(`${a.name} ${a.active?'activated':'paused'}.`);renderAgents();}}
function runAICycle(){const d=AIEngine.runAutoCycle();renderAgents();if(!d)notify('AI Cycle complete ‚Äî no deals matched criteria this round.','info');}
function runAllMatches(){const matches=AIEngine.findMatches();let done=0;matches.slice(0,5).forEach(m=>{const agent=m.buyerAgent||m.licenseeAgent;if(!agent||!agent.active)return;const nego=AIEngine.negotiate(m);if(nego.steps.every(s=>s.status==='done')){transactions.push({id:transactions.length+1,patentId:m.patent.id,type:m.type==='trade'?'Trade':'License',buyer:agent.name,amount:nego.finalPrice,date:new Date().toISOString().slice(0,10),status:'AI Auto',agentId:agent.id,isAI:true});agent.deals++;agent.spent+=nego.finalPrice;done++;addFeed(agent.avatar,agent.bg,`${agent.name} ‚Äî Auto Deal`,`${m.type} on ${m.patent.title} at ${fUSD(nego.finalPrice)}`,agent.id);}});notify(`Auto-matched ${done} deal(s)!`,'info');renderAgents();}
function runSingleAgent(id){const a=aiAgents.find(x=>x.id===id);if(!a||!a.active){notify('Agent is not active.','error');return;}const matches=AIEngine.findMatches().filter(m=>(m.buyerAgent?.id||m.licenseeAgent?.id)===id);let done=0;matches.slice(0,2).forEach(m=>{const nego=AIEngine.negotiate(m);if(nego.steps.every(s=>s.status==='done')){transactions.push({id:transactions.length+1,patentId:m.patent.id,type:m.type==='trade'?'Trade':'License',buyer:a.name,amount:nego.finalPrice,date:new Date().toISOString().slice(0,10),status:'AI Auto',agentId:a.id,isAI:true});a.deals++;a.spent+=nego.finalPrice;done++;addFeed(a.avatar,a.bg,`${a.name} ‚Äî Deal`,`${m.type} on ${m.patent.title}`,a.id);}});notify(`${a.name}: ${done} deal(s) completed.`,'info');renderAgents();}

function autoAgentDeal(pid){const p=patents.find(x=>x.id===pid);if(!p)return;const role=currentRole==='buyer'||currentRole==='licensee'?currentRole:currentRole==='seller'?'buyer':'buyer';const agent=aiAgents.filter(a=>a.active&&(a.role===role||a.role==='broker')).sort((a,b)=>AIEngine.scoreForAgent(p,b)-AIEngine.scoreForAgent(p,a))[0];if(!agent){notify('No suitable active AI agent found.','error');return;}runAgentNego(pid,agent.id);}

function runAgentNego(pid,aid){const p=patents.find(x=>x.id===pid);const a=aiAgents.find(x=>x.id===aid);if(!p||!a)return;const m={type:a.role==='licensee'?'license':'trade',patent:p,buyerAgent:a.role!=='licensee'?a:null,licenseeAgent:a.role==='licensee'?a:null,score:AIEngine.scoreForAgent(p,a)};const nego=AIEngine.negotiate(m);
  let h=`<div class="info-box info-box-blue"><div style="display:flex;gap:10px;align-items:center"><span style="font-size:28px">${a.avatar}</span><div><div class="info-title">${a.name} ‚Üí ${p.title}</div><div class="info-sub">${a.strategy} strategy ¬∑ Score: ${m.score}/100 ¬∑ ${m.type}</div></div></div></div>`;
  h+=`<div class="nego-timeline">`;
  nego.steps.forEach(s=>{h+=`<div class="nego-step ${s.status}"><div class="ns-title">${s.status==='done'?'‚úÖ':s.status==='active'?'üîÑ':'‚è≥'} ${s.title}</div><div class="ns-desc">${s.desc}</div></div>`;});
  h+=`</div>`;
  const allDone=nego.steps.every(s=>s.status==='done');
  h+=`<div style="display:flex;gap:10px;margin-top:16px">`;
  if(allDone){
    h+=`<button class="btn btn-emerald btn-lg" onclick="confirmAgentDeal('${p.id}','${a.id}',${nego.finalPrice},'${m.type}')">‚úÖ Confirm & Execute Deal</button>`;
  }else{
    h+=`<button class="btn btn-primary btn-lg" onclick="forceAgentDeal('${p.id}','${a.id}',${nego.finalPrice},'${m.type}')">‚ö° Force Execute</button>`;
  }
  h+=`<button class="btn btn-gray btn-lg" onclick="closeModal('negoModal')">Close</button></div>`;
  document.getElementById('negoModalBody').innerHTML=h;openModal('negoModal');
}
function confirmAgentDeal(pid,aid,price,type){const a=aiAgents.find(x=>x.id===aid);transactions.push({id:transactions.length+1,patentId:pid,type:type==='trade'?'Trade':'License',buyer:a.name,amount:price,date:new Date().toISOString().slice(0,10),status:'AI Auto',agentId:aid,isAI:true});a.deals++;a.spent+=price;addFeed(a.avatar,a.bg,`${a.name} ‚Äî Deal Confirmed`,`${type} on ${pid} at ${fUSD(price)}`,aid);closeModal('negoModal');notify(`Deal confirmed! ${fUSD(price)}`,'success');}
function forceAgentDeal(pid,aid,price,type){confirmAgentDeal(pid,aid,price,type);}

function viewAgentDetail(id){const a=aiAgents.find(x=>x.id===id);if(!a)return;
  const agentTx=transactions.filter(t=>t.agentId===id);
  const relPatents=patents.map(p=>({p,s:AIEngine.scoreForAgent(p,a)})).filter(x=>x.s>0).sort((a,b)=>b.s-a.s);
  let h=`<div style="display:flex;gap:14px;align-items:center;margin-bottom:16px"><div class="agent-avatar" style="background:${a.bg};width:60px;height:60px;font-size:32px">${a.avatar}</div><div><div style="font-size:18px;font-weight:800">${a.name}</div><div style="font-size:12px;color:var(--gray-500)">${a.desc}</div><div style="margin-top:4px">${roleBadge(a.role)} ${badge(a.strategy,a.strategy==='aggressive'?'red':'blue')}</div></div></div>`;
  h+=`<div class="detail-grid">
    <div class="detail-item"><div class="d-label">Role</div><div class="d-value">${a.role}</div></div>
    <div class="detail-item"><div class="d-label">Strategy</div><div class="d-value">${a.strategy}</div></div>
    <div class="detail-item"><div class="d-label">Budget</div><div class="d-value">${fUSD(a.budget)}</div></div>
    <div class="detail-item"><div class="d-label">Spent</div><div class="d-value">${fUSD(a.spent)}</div></div>
    <div class="detail-item"><div class="d-label">Deals</div><div class="d-value">${a.deals}</div></div>
    <div class="detail-item"><div class="d-label">Interests</div><div class="d-value" style="font-size:11px">${a.interests.join(', ')}</div></div>
  </div>`;
  if(relPatents.length){h+=`<div style="font-weight:700;font-size:13px;margin:12px 0 8px">Top Matching Patents</div><table><thead><tr><th>Patent</th><th>Score</th><th>Value</th><th>Action</th></tr></thead><tbody>`;relPatents.slice(0,5).forEach(x=>{h+=`<tr><td style="font-weight:600;font-size:11px">${x.p.title.slice(0,30)}${x.p.isSEP?' ‚òÖ':''}</td><td><span class="rec-score">${x.s}</span></td><td>${fUSD(x.p.value)}</td><td><button class="btn btn-purple" onclick="closeModal('agentModal');runAgentNego('${x.p.id}','${a.id}')">ü§ñ Deal</button></td></tr>`;});h+=`</tbody></table>`;}
  if(agentTx.length){h+=`<div style="font-weight:700;font-size:13px;margin:12px 0 8px">Transaction History</div><table><thead><tr><th>Patent</th><th>Type</th><th>Amount</th><th>Date</th></tr></thead><tbody>`;agentTx.forEach(t=>{h+=`<tr><td class="mono">${t.patentId}</td><td>${typeBadge(t.type)}</td><td style="font-weight:700">${fUSD(t.amount)}</td><td>${t.date}</td></tr>`;});h+=`</tbody></table>`;}
  document.getElementById('agentModalTitle').textContent=a.name+' ‚Äî Detail';document.getElementById('agentModalBody').innerHTML=h;openModal('agentModal');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHART TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let chartTabP=0,chartTabPer='daily';
function renderChartTab(){
  const p=patents[chartTabP];
  let h=`<div class="card" style="padding:14px 18px;margin-bottom:10px">
    <div style="font-size:12px;font-weight:700;margin-bottom:8px">Select Patent <span style="color:var(--gray-400);font-size:10px">ÌäπÌóà ÏÑ†ÌÉù</span></div>
    <div class="chart-patent-select">${patents.map((pt,i)=>`<div class="chart-patent-chip${i===chartTabP?' active':''}" onclick="chartTabP=${i};renderChartTab()">${pt.isSEP?'‚òÖ ':''}${pt.title.length>16?pt.title.slice(0,16)+'‚Ä¶':pt.title}</div>`).join('')}</div>
  </div>
  <div class="candle-wrap">
    <div class="candle-toolbar"><span class="tb-label">${p.title}</span>${p.isSEP?'<span class="badge-sep" style="margin-left:6px">SEP</span>':''}<div class="tb-sep"></div>
    <button class="tb-btn${chartTabPer==='daily'?' active':''}" onclick="chartTabPer='daily';renderChartTab()">Daily</button>
    <button class="tb-btn${chartTabPer==='weekly'?' active':''}" onclick="chartTabPer='weekly';renderChartTab()">Weekly</button>
    <button class="tb-btn${chartTabPer==='monthly'?' active':''}" onclick="chartTabPer='monthly';renderChartTab()">Monthly</button>
    <div class="tb-sep"></div><span class="tb-label">Current</span><span style="font-size:14px;font-weight:800;color:#22c55e" id="chartCurP"></span></div>
    <div class="candle-info" id="chartTabInfo"><span style="color:var(--gray-500)">Hover for details ¬∑ ÎßàÏö∞Ïä§Î•º Ïò¨Î†§Î≥¥ÏÑ∏Ïöî</span></div>
    <div class="candle-canvas-wrap"><canvas id="chartTabCv"></canvas></div>
    <div class="candle-legend"><span><span class="leg-dot" style="background:#f59e0b"></span>MA5</span><span><span class="leg-dot" style="background:#3b82f6"></span>MA20</span><span><span class="leg-dot" style="background:#ec4899"></span>MA60</span><span style="margin-left:auto"><span style="color:#22c55e">‚ñ†</span> Bull</span><span><span style="color:#ef4444">‚ñ†</span> Bear</span></div>
  </div>`;
  document.getElementById('tab-chart').innerHTML=h;
  const daily=getOHLC(p),ohlc=aggOHLC(daily,chartTabPer),last=ohlc[ohlc.length-1];
  document.getElementById('chartCurP').textContent=fUSD(last.close*1e8);
  setTimeout(()=>{drawCandle('chartTabCv',ohlc,{height:440});setupHover('chartTabCv','chartTabInfo');},50);
}
let candleMP='daily';
function openCandleModal(pid){currentPatent=patents.find(p=>p.id===pid);if(!currentPatent)return;candleMP='daily';renderCM();openModal('candleModal');}
function setCMP(p){candleMP=p;renderCM();}
function renderCM(){const p=currentPatent;const daily=getOHLC(p),ohlc=aggOHLC(daily,candleMP),last=ohlc[ohlc.length-1];
  document.getElementById('candleModalTitle').textContent=p.title+' ‚Äî Value Chart';
  document.getElementById('candleModalBody').innerHTML=`<div class="candle-wrap" style="border-radius:0"><div class="candle-toolbar"><span class="tb-label">${p.owner}</span>${p.isSEP?'<span class="badge-sep" style="margin-left:6px">SEP</span>':''}<div class="tb-sep"></div><button class="tb-btn${candleMP==='daily'?' active':''}" onclick="setCMP('daily')">Daily</button><button class="tb-btn${candleMP==='weekly'?' active':''}" onclick="setCMP('weekly')">Weekly</button><button class="tb-btn${candleMP==='monthly'?' active':''}" onclick="setCMP('monthly')">Monthly</button><div class="tb-sep"></div><span style="font-size:14px;font-weight:800;color:#22c55e">${fUSD(last.close*1e8)}</span></div><div class="candle-info" id="cmI"><span style="color:var(--gray-500)">Hover for details</span></div><div class="candle-canvas-wrap"><canvas id="cmCv"></canvas></div><div class="candle-legend"><span><span class="leg-dot" style="background:#f59e0b"></span>MA5</span><span><span class="leg-dot" style="background:#3b82f6"></span>MA20</span><span><span class="leg-dot" style="background:#ec4899"></span>MA60</span></div></div>`;
  setTimeout(()=>{drawCandle('cmCv',ohlc,{height:420});setupHover('cmCv','cmI');},80);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VALUE ANALYSIS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderValue(){
  let h=`<div class="chart-row">
    <div class="card"><h3>Tech/Market/Legal Scores <span class="kr">Í∏∞Ïà†¬∑ÏãúÏû•¬∑Î≤ïÎ•†</span></h3><div class="chart-container"><canvas id="cRadar"></canvas></div></div>
    <div class="card"><h3>Value Distribution <span class="kr">Í∞ÄÏπò Î∂ÑÌè¨</span></h3><div class="chart-container"><canvas id="cDist"></canvas></div></div>
  </div>
  <div class="card"><h3>Patent Score Table <span class="kr">ÌäπÌóà Ï†êÏàòÌëú</span></h3>
  <table><thead><tr><th>Patent</th><th>Type</th><th>Tech</th><th>Market</th><th>Legal</th><th>Avg</th><th>Value</th></tr></thead><tbody>
  ${patents.map(p=>{const a=Math.round((p.techScore+p.marketScore+p.legalScore)/3);return`<tr><td style="font-weight:600;font-size:11px">${p.title.slice(0,25)}</td><td>${p.isSEP?'<span class="badge-sep">SEP</span>':badge('Gen','gray')}</td><td><span class="score-bar-bg"><span class="score-bar" style="width:${p.techScore}%;background:#3b82f6"></span></span>${p.techScore}</td><td><span class="score-bar-bg"><span class="score-bar" style="width:${p.marketScore}%;background:var(--emerald)"></span></span>${p.marketScore}</td><td><span class="score-bar-bg"><span class="score-bar" style="width:${p.legalScore}%;background:var(--amber)"></span></span>${p.legalScore}</td><td style="font-weight:700;color:var(--navy)">${a}</td><td style="font-weight:600">${fUSD(p.value)}</td></tr>`;}).join('')}
  </tbody></table></div>`;
  document.getElementById('tab-value').innerHTML=h;
  const colors=['#1e3a5f','#06b6d4','#10b981','#f59e0b','#ef4444','#8b5cf6','#ec4899','#14b8a6','#3b82f6','#6366f1'];
  destroyChart('radar');chartInstances.radar=new Chart(document.getElementById('cRadar'),{type:'radar',data:{labels:patents.map(p=>(p.isSEP?'‚òÖ ':'')+p.title.slice(0,10)),datasets:[{label:'Tech',data:patents.map(p=>p.techScore),borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,.1)',borderWidth:2},{label:'Market',data:patents.map(p=>p.marketScore),borderColor:'#10b981',backgroundColor:'rgba(16,185,129,.1)',borderWidth:2},{label:'Legal',data:patents.map(p=>p.legalScore),borderColor:'#f59e0b',backgroundColor:'rgba(245,158,11,.1)',borderWidth:2}]},options:{responsive:true,maintainAspectRatio:false,scales:{r:{min:60,max:100}},plugins:{legend:{position:'bottom',labels:{font:{size:10}}}}}});
  const dist=[{r:'<$5M',c:patents.filter(p=>p.value<5e8).length},{r:'$5-10M',c:patents.filter(p=>p.value>=5e8&&p.value<1e9).length},{r:'$10-15M',c:patents.filter(p=>p.value>=1e9&&p.value<1.5e9).length},{r:'$15-20M',c:patents.filter(p=>p.value>=1.5e9&&p.value<2e9).length},{r:'>$20M',c:patents.filter(p=>p.value>=2e9).length}];
  destroyChart('dist');chartInstances.dist=new Chart(document.getElementById('cDist'),{type:'bar',data:{labels:dist.map(d=>d.r),datasets:[{label:'Patents',data:dist.map(d=>d.c),backgroundColor:colors.slice(0,5),borderRadius:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TRANSACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderTransactions(){
  let h=`<div class="card"><h3>All Transactions <span class="kr">Ï†ÑÏ≤¥ Í±∞Îûò ÎÇ¥Ïó≠</span></h3>`;
  if(!transactions.length)h+=`<p style="text-align:center;color:var(--gray-400);padding:30px;font-size:12px">No transactions yet. Use AI agents to auto-generate deals.</p>`;
  else{h+=`<table><thead><tr><th>#</th><th>Patent</th><th>Type</th><th>Counterparty</th><th>Amount</th><th>Date</th><th>Status</th><th>AI</th></tr></thead><tbody>`;
  transactions.slice().reverse().forEach(tx=>{h+=`<tr><td style="color:var(--gray-400)">${tx.id}</td><td class="mono">${tx.patentId}</td><td>${typeBadge(tx.type)}</td><td style="font-weight:600">${tx.buyer}</td><td style="font-weight:700">${fUSD(tx.amount)}</td><td style="color:var(--gray-500)">${tx.date}</td><td>${txBadge(tx.status)}</td><td>${tx.isAI?'ü§ñ':''}</td></tr>`;});
  h+=`</tbody></table>`;}
  h+=`</div>`;document.getElementById('tab-transactions').innerHTML=h;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DETAIL MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openDetail(pid){currentPatent=patents.find(p=>p.id===pid);if(!currentPatent)return;const p=currentPatent;const avg=Math.round((p.techScore+p.marketScore+p.legalScore)/3);
  const agentScores=aiAgents.filter(a=>a.active).map(a=>({a,s:AIEngine.scoreForAgent(p,a)})).filter(x=>x.s>0).sort((a,b)=>b.s-a.s);
  let h=`<div style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:14px;margin-bottom:16px">
    <div><div class="patent-meta" style="margin-bottom:6px"><span class="mono" style="font-size:12px">${p.id}</span>${statusBadge(p.status)}${sepBadge(p)}</div>
    <div style="font-size:16px;font-weight:800">${p.title}</div><div style="font-size:12px;color:var(--gray-400)">${p.titleKr}</div></div>
    <div style="text-align:right"><div style="font-size:24px;font-weight:800;color:var(--navy)">${fUSD(p.value)}</div><div style="font-size:11px;color:var(--gray-400)">${fKRW(p.value)}</div></div>
  </div>
  ${p.isSEP?`<div style="margin-bottom:12px">${sepInd(p)}</div>`:''}
  <div class="detail-grid">
    <div class="detail-item"><div class="d-label">Owner</div><div class="d-value">${p.owner}</div></div>
    <div class="detail-item"><div class="d-label">Field</div><div class="d-value">${p.field}</div></div>
    <div class="detail-item"><div class="d-label">Filed</div><div class="d-value">${p.filingDate}</div></div>
    <div class="detail-item"><div class="d-label">Claims</div><div class="d-value">${p.claims}</div></div>
    <div class="detail-item"><div class="d-label">Cited By</div><div class="d-value">${p.citedBy}</div></div>
    <div class="detail-item"><div class="d-label">Life</div><div class="d-value">${p.remainingYears}yr</div></div>
  </div>
  <div style="background:var(--gray-50);border-radius:12px;padding:14px;margin-bottom:14px">
    <div style="font-size:11px;font-weight:700;color:var(--gray-600);margin-bottom:6px">Description</div>
    <div style="font-size:12px;color:var(--gray-600);line-height:1.6">${p.description}</div>
  </div>
  <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px;text-align:center">
    <div><div style="font-size:9px;color:var(--gray-500)">TECH</div><div style="font-size:24px;font-weight:800;color:#3b82f6">${p.techScore}</div></div>
    <div><div style="font-size:9px;color:var(--gray-500)">MARKET</div><div style="font-size:24px;font-weight:800;color:var(--emerald)">${p.marketScore}</div></div>
    <div><div style="font-size:9px;color:var(--gray-500)">LEGAL</div><div style="font-size:24px;font-weight:800;color:var(--amber)">${p.legalScore}</div></div>
  </div>`;
  if(agentScores.length){h+=`<div style="font-weight:700;font-size:12px;margin-bottom:8px">ü§ñ AI Agent Interest</div><div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px">`;agentScores.forEach(x=>{h+=`<div style="background:${x.a.bg};padding:6px 10px;border-radius:8px;font-size:11px"><span style="font-size:14px">${x.a.avatar}</span> ${x.a.name} <span class="rec-score">${x.s}</span></div>`;});h+=`</div>`;}
  h+=`<div style="display:flex;gap:10px;flex-wrap:wrap">
    <button class="btn btn-outline btn-lg" onclick="closeModal('detailModal');openCandleModal('${p.id}')">üìà Chart</button>
    ${p.forSale?`<button class="btn btn-primary btn-lg" onclick="closeModal('detailModal');openTrade('${p.id}')">Trade</button>`:''}
    ${p.forLicense?`<button class="btn btn-emerald btn-lg" onclick="closeModal('detailModal');openLicense('${p.id}')">License</button>`:''}
    <button class="btn btn-purple btn-lg" onclick="closeModal('detailModal');autoAgentDeal('${p.id}')">ü§ñ AI Deal</button>
  </div>`;
  document.getElementById('detailBody').innerHTML=h;openModal('detailModal');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TRADE MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openTrade(pid){currentPatent=patents.find(p=>p.id===pid);if(!currentPatent)return;const p=currentPatent;
  document.getElementById('tradeBody').innerHTML=`
  <div class="info-box info-box-blue"><div class="info-label" style="color:#2563eb">Target Patent</div>
  <div class="info-title">${p.title}${p.isSEP?' <span class="badge-sep">SEP</span>':''}</div><div class="info-sub">Valuation: <strong style="color:var(--navy)">${fUSD(p.value)}</strong> (${fKRW(p.value)})</div></div>
  <div class="form-group"><label class="form-label">${currentRole==='buyer'?'Buyer':'Seller'} Name * <span class="kr">Ïù¥Î¶Ñ</span></label><input class="form-input" id="tradeBuyer" placeholder="Name"></div>
  <div class="form-group"><label class="form-label">Organization <span class="kr">Í∏∞Í¥Ä</span></label><input class="form-input" id="tradeOrg" placeholder="Company"></div>
  <div class="form-group"><label class="form-label">Offer Price (KRW) * <span class="kr">Ï†úÏïàÍ∞Ä</span></label><input class="form-input" type="number" id="tradePrice" placeholder="Amount" oninput="document.getElementById('tradeH').textContent=this.value?fUSD(parseInt(this.value)):''"><div class="form-hint" id="tradeH"></div></div>
  <div class="form-group"><label class="form-label">Message <span class="kr">Î©îÏãúÏßÄ</span></label><textarea class="form-textarea" id="tradeMsg" rows="2" placeholder="Note"></textarea></div>
  <div style="display:flex;gap:10px;margin-top:16px"><button class="btn btn-gray btn-lg" onclick="closeModal('tradeModal')">Cancel</button><button class="btn btn-primary btn-lg" onclick="submitTrade()">Submit</button></div>`;
  openModal('tradeModal');
}
function submitTrade(){const b=document.getElementById('tradeBuyer').value,pr=document.getElementById('tradePrice').value;if(!b||!pr){notify('Name and price required.','error');return;}transactions.push({id:transactions.length+1,patentId:currentPatent.id,type:'Trade',buyer:document.getElementById('tradeOrg').value||b,amount:parseInt(pr),date:new Date().toISOString().slice(0,10),status:'Negotiating',isAI:false});closeModal('tradeModal');notify('Trade request submitted!');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LICENSE MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let licType='lumpsum';
function openLicense(pid){currentPatent=patents.find(p=>p.id===pid);if(!currentPatent)return;licType='lumpsum';renderLM();openModal('licenseModal');}
function setLT(t){licType=t;renderLM();}
function renderLM(){const p=currentPatent;const durs=[1,2,3,5,7,10,15,20];const terr=['Korea','Asia-Pacific','Worldwide (Non-exclusive)','Worldwide (Exclusive)'];
  let cond='';
  if(licType==='lumpsum'){cond=`<div class="condition-box"><h4>Lump Sum <span style="font-size:10px;color:var(--gray-400);font-weight:400">ÏùºÏãúÎ∂à</span></h4>
    <div class="form-group"><label class="form-label">Amount (KRW)</label><input class="form-input" type="number" id="lumpAmt" placeholder="Amount" oninput="document.getElementById('lumpH').textContent=this.value?fUSD(parseInt(this.value)):''"><div class="form-hint" id="lumpH"></div></div>
    <div class="form-row"><div class="form-group"><label class="form-label">Duration</label><select class="form-select" id="licDur">${durs.map(y=>`<option value="${y}"${y===5?' selected':''}>${y}yr</option>`).join('')}</select></div>
    <div class="form-group"><label class="form-label">Territory</label><select class="form-select" id="licTerr">${terr.map(t=>`<option>${t}</option>`).join('')}</select></div></div></div>`;}
  else{cond=`<div class="condition-box"><h4>Running Royalty <span style="font-size:10px;color:var(--gray-400);font-weight:400">Îü¨ÎãùÎ°úÏó¥Ìã∞</span></h4>
    <div class="form-row"><div class="form-group"><label class="form-label">Rate (%)</label><input class="form-input" type="number" step="0.1" id="royRate" placeholder="e.g. 3.5" oninput="updateRS()"></div>
    <div class="form-group"><label class="form-label">Base</label><select class="form-select" id="royBase"><option>Revenue</option><option>Net Revenue</option><option>Per Unit</option></select></div></div>
    <div class="form-group"><label class="form-label">Min Annual (KRW)</label><input class="form-input" type="number" id="minRoy" placeholder="Minimum"></div>
    <div class="form-row"><div class="form-group"><label class="form-label">Duration</label><select class="form-select" id="licDur">${durs.map(y=>`<option value="${y}"${y===5?' selected':''}>${y}yr</option>`).join('')}</select></div>
    <div class="form-group"><label class="form-label">Territory</label><select class="form-select" id="licTerr">${terr.map(t=>`<option>${t}</option>`).join('')}</select></div></div>
    <div class="sim-box" id="roySim" style="display:none"><div class="sim-label">Sim ($100M revenue)</div><div class="sim-value" id="simV"></div><div class="sim-sub" id="simT"></div></div></div>`;}
  document.getElementById('licenseBody').innerHTML=`
  <div class="info-box info-box-emerald"><div class="info-label" style="color:var(--emerald-d)">Target Patent</div>
  <div class="info-title">${p.title}${p.isSEP?' <span class="badge-sep">SEP</span>':''}</div><div class="info-sub">Owner: ${p.owner} ¬∑ ${fUSD(p.value)}</div></div>
  <div style="margin-bottom:14px"><label class="form-label">Payment Type <span class="kr">ÏßÄÍ∏â Î∞©Ïãù</span></label>
  <div class="type-grid"><div class="type-card${licType==='lumpsum'?' selected':''}" onclick="setLT('lumpsum')"><h4>Lump Sum</h4><p>One-time ¬∑ ÏùºÏãúÎ∂à</p></div>
  <div class="type-card${licType==='running'?' selected':''}" onclick="setLT('running')"><h4>Running Royalty</h4><p>Ongoing ¬∑ Îü¨ÎãùÎ°úÏó¥Ìã∞</p></div></div></div>
  <div class="form-row"><div class="form-group"><label class="form-label">${currentRole==='licensor'?'Licensee':'Licensor'} * <span class="kr">ÏÉÅÎåÄÎ∞©</span></label><input class="form-input" id="licensee" placeholder="Name"></div>
  <div class="form-group"><label class="form-label">Organization <span class="kr">Í∏∞Í¥Ä</span></label><input class="form-input" id="licOrg" placeholder="Company"></div></div>
  ${cond}
  <div style="display:flex;gap:10px;margin-top:16px"><button class="btn btn-gray btn-lg" onclick="closeModal('licenseModal')">Cancel</button>
  <button class="btn btn-emerald btn-lg" onclick="submitLicense()">Submit License</button></div>`;
}
function updateRS(){const r=parseFloat(document.getElementById('royRate')?.value||0);const s=document.getElementById('roySim');if(r>0){s.style.display='block';const a=1e10*r/100;const d=parseInt(document.getElementById('licDur')?.value||5);document.getElementById('simV').textContent=fUSD(a)+'/yr';document.getElementById('simT').textContent=d+'yr total: '+fUSD(a*d);}else s.style.display='none';}
function submitLicense(){const l=document.getElementById('licensee')?.value;if(!l){notify('Name required.','error');return;}let amt=0;if(licType==='lumpsum')amt=parseInt(document.getElementById('lumpAmt')?.value||0);else amt=parseInt(document.getElementById('minRoy')?.value||0);transactions.push({id:transactions.length+1,patentId:currentPatent.id,type:'License',buyer:document.getElementById('licOrg')?.value||l,amount:amt,date:new Date().toISOString().slice(0,10),status:'Negotiating',isAI:false});closeModal('licenseModal');notify('License request submitted!');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UPLOAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let upMode='form';let csvData=[];
function openUploadModal(){upMode='form';csvData=[];renderUM();openModal('uploadModal');}
function setUM(m){upMode=m;renderUM();}
function renderUM(){
  const fields=['AI','Security','Energy','Software','Bio','Manufacturing','Telecom','Environment','Other'];
  let h=`<div class="type-grid" style="margin-bottom:14px">
    <div class="type-card${upMode==='form'?' selected':''}" onclick="setUM('form')"><h4>Manual Entry <span style="font-size:10px;color:var(--gray-400)">ÏßÅÏ†ë ÏûÖÎ†•</span></h4><p>Single patent</p></div>
    <div class="type-card${upMode==='csv'?' selected':''}" onclick="setUM('csv')"><h4>CSV Upload <span style="font-size:10px;color:var(--gray-400)">ÌååÏùº</span></h4><p>Bulk upload</p></div></div>`;
  if(upMode==='form'){
    h+=`<div class="form-row"><div class="form-group"><label class="form-label">Title * <span class="kr">Ï†úÎ™©</span></label><input class="form-input" id="upTitle"></div>
    <div class="form-group"><label class="form-label">ID <span class="kr">Î≤àÌò∏</span></label><input class="form-input" id="upId" placeholder="Auto if empty"></div></div>
    <div class="form-row"><div class="form-group"><label class="form-label">Korean Title <span class="kr">ÌïúÍ∏Ä</span></label><input class="form-input" id="upTitleKr"></div>
    <div class="form-group"><label class="form-label">Owner * <span class="kr">ÏÜåÏú†Ïûê</span></label><input class="form-input" id="upOwner"></div></div>
    <div class="form-row-3"><div class="form-group"><label class="form-label">Field *</label><select class="form-select" id="upField">${fields.map(f=>`<option>${f}</option>`).join('')}</select></div>
    <div class="form-group"><label class="form-label">Status</label><select class="form-select" id="upStatus"><option>Granted</option><option>Published</option><option>Under Review</option></select></div>
    <div class="form-group"><label class="form-label">Filing Date</label><input class="form-input" type="date" id="upDate"></div></div>
    <div class="form-row-3"><div class="form-group"><label class="form-label">Value (KRW) *</label><input class="form-input" type="number" id="upValue"></div>
    <div class="form-group"><label class="form-label">Claims</label><input class="form-input" type="number" id="upClaims" value="10"></div>
    <div class="form-group" style="display:flex;align-items:center;padding-top:20px"><label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:12px;font-weight:600"><input type="checkbox" id="upSEP" style="width:16px;height:16px;accent-color:#f59e0b" onchange="document.getElementById('sepF').style.display=this.checked?'block':'none'">‚òÖ SEP</label></div></div>
    <div id="sepF" style="display:none"><div class="form-group"><label class="form-label">SEP Standard</label><input class="form-input" id="upSepStd" placeholder="e.g. 3GPP TS 38.214"></div></div>
    <div class="form-row"><div class="form-group"><label style="display:flex;align-items:center;gap:6px;font-size:12px;font-weight:600"><input type="checkbox" id="upForSale" checked style="width:14px;height:14px">For Sale</label></div>
    <div class="form-group"><label style="display:flex;align-items:center;gap:6px;font-size:12px;font-weight:600"><input type="checkbox" id="upForLic" checked style="width:14px;height:14px">Licensable</label></div></div>
    <div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" id="upDesc" rows="2"></textarea></div>
    <div style="display:flex;gap:10px;margin-top:14px"><button class="btn btn-gray btn-lg" onclick="closeModal('uploadModal')">Cancel</button><button class="btn btn-orange btn-lg" onclick="submitUp()">Register</button></div>`;
  }else{
    h+=`<div class="upload-zone" id="uploadZone" onclick="document.getElementById('csvFile').click()" ondragover="event.preventDefault();this.classList.add('dragover')" ondragleave="this.classList.remove('dragover')" ondrop="event.preventDefault();this.classList.remove('dragover');handleCSVDrop(event)">
    <p>Drag & drop CSV or click to upload</p></div><input type="file" id="csvFile" accept=".csv" style="display:none" onchange="handleCSVSel(event)"><div id="csvPrev"></div>
    <div style="display:flex;gap:10px;margin-top:14px"><button class="btn btn-gray btn-lg" onclick="closeModal('uploadModal')">Cancel</button><button class="btn btn-orange btn-lg" id="csvBtn" onclick="submitCSV()" style="display:none">Register (<span id="csvCnt">0</span>)</button></div>`;
  }
  document.getElementById('uploadBody').innerHTML=h;
}
function submitUp(){const t=document.getElementById('upTitle')?.value?.trim(),o=document.getElementById('upOwner')?.value?.trim(),v=parseInt(document.getElementById('upValue')?.value||0);if(!t||!o||!v){notify('Title, Owner, Value required.','error');return;}const isSEP=document.getElementById('upSEP')?.checked||false;const id=document.getElementById('upId')?.value?.trim()||('KR-'+new Date().getFullYear()+'-'+String(Math.floor(Math.random()*900000)+100000));patents.push({id,title:t,titleKr:document.getElementById('upTitleKr')?.value||t,owner:o,ownerKr:o,field:document.getElementById('upField')?.value||'Other',fieldKr:'Í∏∞ÌÉÄ',filingDate:document.getElementById('upDate')?.value||new Date().toISOString().slice(0,10),status:document.getElementById('upStatus')?.value||'Granted',value:v,description:document.getElementById('upDesc')?.value||'',descKr:'',claims:parseInt(document.getElementById('upClaims')?.value||10),citedBy:0,remainingYears:18,techScore:85,marketScore:80,legalScore:85,isSEP,sepStandard:isSEP?document.getElementById('upSepStd')?.value||'':'',forSale:document.getElementById('upForSale')?.checked??true,forLicense:document.getElementById('upForLic')?.checked??true});closeModal('uploadModal');updateTV();notify(`"${t}" registered!${isSEP?' (SEP)':''}`);}
function parseCSV(text){const lines=text.split('\n').map(l=>l.trim()).filter(l=>l);if(lines.length<2)return[];const hd=lines[0].split(',').map(h=>h.trim().replace(/"/g,''));return lines.slice(1).map(line=>{const vals=[];let cur='',inQ=false;for(const ch of line){if(ch==='"')inQ=!inQ;else if(ch===','&&!inQ){vals.push(cur.trim());cur='';}else cur+=ch;}vals.push(cur.trim());const obj={};hd.forEach((h,i)=>obj[h]=vals[i]||'');return obj;});}
function handleCSVSel(e){const f=e.target.files[0];if(f)readCSV(f);}
function handleCSVDrop(e){const f=e.dataTransfer.files[0];if(f)readCSV(f);}
function readCSV(file){const r=new FileReader();r.onload=function(e){csvData=parseCSV(e.target.result);if(!csvData.length){notify('Parse failed.','error');return;}document.getElementById('csvBtn').style.display='';document.getElementById('csvCnt').textContent=csvData.length;document.getElementById('csvPrev').innerHTML=`<div style="background:var(--gray-50);border-radius:10px;padding:10px;font-size:11px;max-height:180px;overflow:auto"><table><thead><tr>${Object.keys(csvData[0]).map(k=>`<th>${k}</th>`).join('')}</tr></thead><tbody>${csvData.slice(0,5).map(r=>`<tr>${Object.values(r).map(v=>`<td>${v}</td>`).join('')}</tr>`).join('')}</tbody></table></div>`;};r.readAsText(file);}
function submitCSV(){let n=0;csvData.forEach(r=>{const t=r.title||r.Title||r['Ï†úÎ™©'],o=r.owner||r.Owner||r['ÏÜåÏú†Ïûê'],v=parseInt(r.value||r.Value||r['Í∞ÄÏπò']||0);if(!t||!o||!v)return;patents.push({id:r.id||('KR-'+new Date().getFullYear()+'-'+String(Math.floor(Math.random()*900000)+100000)),title:t,titleKr:r.titleKr||t,owner:o,ownerKr:r.ownerKr||o,field:r.field||'Other',fieldKr:'Í∏∞ÌÉÄ',filingDate:r.filingDate||new Date().toISOString().slice(0,10),status:r.status||'Granted',value:v,description:r.description||'',descKr:'',claims:parseInt(r.claims||10),citedBy:0,remainingYears:18,techScore:parseInt(r.techScore||85),marketScore:parseInt(r.marketScore||80),legalScore:parseInt(r.legalScore||85),isSEP:r.isSEP==='true',sepStandard:r.sepStandard||'',forSale:true,forLicense:true});n++;});closeModal('uploadModal');updateTV();notify(`${n} patents registered.`);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded',()=>{
  updateTV();renderRoleSelector();renderNav();renderDashboard();
  // Initial AI activity
  addFeed('üìä','#f1f5f9','System','Global Patent Exchange initialized. '+patents.length+' patents loaded. '+aiAgents.length+' AI agents ready.','system');
  addFeed('ü§ñ','#eff6ff','AlphaPatent AI','Scanning market for Telecom & AI patent opportunities...','agent-alpha');
  addFeed('üß†','#f0fdf4','BetaLicense AI','Analyzing Energy & Bio licensing targets...','agent-beta');
  addFeed('‚ö°','#fef3c7','GammaSeller AI','Monitoring patent valuations for optimal sale timing...','agent-gamma');
});
</script>
</body>
</html>
